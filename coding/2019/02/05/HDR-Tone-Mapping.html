<!DOCTYPE html><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><title>HDR Tone Mapping - xiaOpçš„åšå®¢</title><meta name=author content=æ½˜å®‡çª><meta name=description content="HDR Tone Mapping"><meta name=keywords content=WebGL><title>HDR Tone Mapping | xiaOpçš„åšå®¢</title><meta name=generator content="Jekyll v3.6.2"><meta property=og:title content="HDR Tone Mapping"><meta name=author content=xiaOp><meta property=og:locale content=en_US><meta name=description content="ã€ŒPhotographic Tone Reproduction for Digital Imagesã€ğŸ”—ã€ŒGradient Domain High Dynamic Range Compressionã€ğŸ”—ã€ŒTone mappingè¿›åŒ–è®ºã€https://zhuanlan.zhihu.com/p/21983679ã€ŒTone mapping: A quick surveyã€ğŸ”—ã€ŒFilmic Tonemapping Operatorsã€ğŸ”—ã€ŒACES Filmic Tone MappingÂ Curveã€ğŸ”—ã€ŒConverting RGB to LogLuv in a fragment shaderã€ğŸ”—ã€ŒRGBM color encodingã€ğŸ”—ã€Œç†è§£é«˜èŒƒå›´åŠ¨æ€å…‰ã€ğŸ”—ã€ŒThree.js å®ç°ã€ğŸ”—ã€ŒThree.js æ•ˆæœã€ğŸ”—http://examples.claygl.xyz/examples/basicPanoramaHDR.html"><meta property=og:description content="ã€ŒPhotographic Tone Reproduction for Digital Imagesã€ğŸ”—ã€ŒGradient Domain High Dynamic Range Compressionã€ğŸ”—ã€ŒTone mappingè¿›åŒ–è®ºã€https://zhuanlan.zhihu.com/p/21983679ã€ŒTone mapping: A quick surveyã€ğŸ”—ã€ŒFilmic Tonemapping Operatorsã€ğŸ”—ã€ŒACES Filmic Tone MappingÂ Curveã€ğŸ”—ã€ŒConverting RGB to LogLuv in a fragment shaderã€ğŸ”—ã€ŒRGBM color encodingã€ğŸ”—ã€Œç†è§£é«˜èŒƒå›´åŠ¨æ€å…‰ã€ğŸ”—ã€ŒThree.js å®ç°ã€ğŸ”—ã€ŒThree.js æ•ˆæœã€ğŸ”—http://examples.claygl.xyz/examples/basicPanoramaHDR.html"><link rel=canonical href=https://xiaoiver.github.io/coding/2019/02/05/HDR-Tone-Mapping.html><meta property=og:url content=https://xiaoiver.github.io/coding/2019/02/05/HDR-Tone-Mapping.html><meta property=og:site_name content=xiaOpçš„åšå®¢><meta property=og:type content=article><meta property=article:published_time content=2019-02-05T00:00:00+08:00><script type=application/ld+json>{"description":"ã€ŒPhotographic Tone Reproduction for Digital Imagesã€ğŸ”—ã€ŒGradient Domain High Dynamic Range Compressionã€ğŸ”—ã€ŒTone mappingè¿›åŒ–è®ºã€https://zhuanlan.zhihu.com/p/21983679ã€ŒTone mapping: A quick surveyã€ğŸ”—ã€ŒFilmic Tonemapping Operatorsã€ğŸ”—ã€ŒACES Filmic Tone MappingÂ Curveã€ğŸ”—ã€ŒConverting RGB to LogLuv in a fragment shaderã€ğŸ”—ã€ŒRGBM color encodingã€ğŸ”—ã€Œç†è§£é«˜èŒƒå›´åŠ¨æ€å…‰ã€ğŸ”—ã€ŒThree.js å®ç°ã€ğŸ”—ã€ŒThree.js æ•ˆæœã€ğŸ”—http://examples.claygl.xyz/examples/basicPanoramaHDR.html","author":{"@type":"Person","name":"xiaOp"},"@type":"BlogPosting","url":"https://xiaoiver.github.io/coding/2019/02/05/HDR-Tone-Mapping.html","headline":"HDR Tone Mapping","dateModified":"2019-02-05T00:00:00+08:00","datePublished":"2019-02-05T00:00:00+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://xiaoiver.github.io/coding/2019/02/05/HDR-Tone-Mapping.html"},"@context":"http://schema.org"}</script><meta name=theme-color content=#4acaa8><meta name=msapplication-TileColor content=#4acaa8><meta name=msapplication-TileImage content=/assets/img/manifest/ms-icon-144x144.png><link rel=apple-touch-icon sizes=57x57 href=/assets/img/manifest/apple-icon-57x57.png><link rel=apple-touch-icon sizes=60x60 href=/assets/img/manifest/apple-icon-60x60.png><link rel=apple-touch-icon sizes=72x72 href=/assets/img/manifest/apple-icon-72x72.png><link rel=apple-touch-icon sizes=76x76 href=/assets/img/manifest/apple-icon-76x76.png><link rel=apple-touch-icon sizes=114x114 href=/assets/img/manifest/apple-icon-114x114.png><link rel=apple-touch-icon sizes=120x120 href=/assets/img/manifest/apple-icon-120x120.png><link rel=apple-touch-icon sizes=144x144 href=/assets/img/manifest/apple-icon-144x144.png><link rel=apple-touch-icon sizes=152x152 href=/assets/img/manifest/apple-icon-152x152.png><link rel=apple-touch-icon sizes=180x180 href=/assets/img/manifest/apple-icon-180x180.png><link rel=icon type=image/png sizes=192x192 href=/assets/img/manifest/android-icon-192x192.png><link rel=icon type=image/png sizes=32x32 href=/assets/img/manifest/favicon-32x32.png><link rel=icon type=image/png sizes=96x96 href=/assets/img/manifest/favicon-96x96.png><link rel=icon type=image/png sizes=16x16 href=/assets/img/manifest/favicon-16x16.png><link rel="shortcut icon" href=/assets/img/manifest/favicon.ico type=image/x-icon><link rel=canonical href=https://xiaoiver.github.io/coding/2019/02/05/HDR-Tone-Mapping.html><link rel=manifest href=/manifest.json><link rel=stylesheet href=//cdn.staticfile.org/normalize/6.0.0/normalize.min.css><link rel=stylesheet href=//at.alicdn.com/t/font_roc50gemkxpw4s4i.css><link rel=stylesheet href=/assets/css/github-markdown.css><link rel=stylesheet href=/assets/css/prism.css><link rel=stylesheet href=/assets/css/share.min.css><link rel=stylesheet href=/assets/css/app.min.css><link rel=stylesheet href=/assets/css/post.min.css><script async src="https://www.googletagmanager.com/gtag/js?id=UA-120929691-1"></script><script>window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'UA-120929691-1');</script><script src=https://cdn.staticfile.org/jquery/3.2.1/jquery.min.js></script><script src=/assets/js/Imager.min.js></script><script src=/assets/js/glsl-canvas.min.js></script><script>function initArrayBuffer(gl, program, attribute, data, type, num) {
            // Create a buffer object
            var buffer = gl.createBuffer();
            if (!buffer) {
                console.log('Failed to create the buffer object');
                return false;
            }
            // Write date into the buffer object
            gl.bindBuffer(gl.ARRAY_BUFFER, buffer);
            gl.bufferData(gl.ARRAY_BUFFER, data, gl.STATIC_DRAW);
            // Assign the buffer object to the attribute variable
            var a_attribute = gl.getAttribLocation(program, attribute);
            if (a_attribute < 0) {
                console.log('Failed to get the storage location of ' + attribute);
                return false;
            }
            gl.vertexAttribPointer(a_attribute, num, type, false, 0, 0);
            // Enable the assignment of the buffer object to the attribute variable
            gl.enableVertexAttribArray(a_attribute);

            gl.bindBuffer(gl.ARRAY_BUFFER, null);

            return true;
        }</script><body><!--[if lt IE 10]>
<div class="alert-danger" role="alert">ä½ çš„æµè§ˆå™¨å®åœ¨å¤ªå¤ªå¤ªæ—§äº†ï¼Œæ”¾å­¦åˆ«èµ°ï¼Œå‡çº§å®Œæµè§ˆå™¨å†è¯´ï¼<a target="_blank" class="alert-link" href="http://browsehappy.com">ç«‹å³å‡çº§</a></div>
<![endif]--> <input id=nm-switch type=hidden value=false><header class=g-header><div class=g-logo><a href=/ ></a></div><i id=menu-toggle class="iconfont icon-menu"></i><nav class=g-nav><ul><li><a href=/ >home</a><li><a href=/tags.html>tags</a><li><a href=/collectives.html>collectives</a></ul></nav></header><header class="g-banner post-header post-pattern-circuitBoard bgcolor-default" data-theme=default><div class=post-wrapper><div class=post-tags><a href=https://xiaoiver.github.io/tags#WebGL class=post-tag>WebGL</a></div><h1>HDR Tone Mapping</h1><div class=post-meta><span class=post-meta-item><i class="iconfont icon-author"></i><a href=https://xiaoiver.github.io target=_blank rel=author>xiaOp</a></span> <time class=post-meta-item datetime=19-02-05><i class="iconfont icon-date"></i>05 Feb 2019</time></div></div><div class=filter></div><div class=post-cover style="background: url('https://intranetproxy.alipay.com/skylark/lark/0/2019/png/158945/1549519347047-9e150ee0-2f35-4bda-a5da-66b8caeff4b5.png#align=left&display=inline&height=209&linkTarget=_blank&originHeight=842&originWidth=1278&size=0&width=317') center no-repeat; background-size: cover"></div></header><div class=post-content><div class=catalog-container><div class=side-catalog><h3 class=catalog-title><a class=catalog-toggle href=#>CATALOG</a></h3><ul class=catalog-body></ul></div></div><article class=markdown-body><p>ã€ŒPhotographic Tone Reproduction for Digital Imagesã€<a href=http://www.cs.huji.ac.il/~danix/hdr/hdrc.pdf>ğŸ”—</a><br>ã€ŒGradient Domain High Dynamic Range Compressionã€<a href="">ğŸ”—</a><br>ã€ŒTone mappingè¿›åŒ–è®ºã€<a href=https://zhuanlan.zhihu.com/p/21983679>https://zhuanlan.zhihu.com/p/21983679</a><br>ã€ŒTone mapping: A quick surveyã€<a href="https://www.phototalks.idv.tw/academic/?p=861">ğŸ”—</a><br>ã€ŒFilmic Tonemapping Operatorsã€<a href=http://filmicworlds.com/blog/filmic-tonemapping-operators/ >ğŸ”—</a><br>ã€ŒACES Filmic Tone MappingÂ Curveã€<a href=https://knarkowicz.wordpress.com/2016/01/06/aces-filmic-tone-mapping-curve/ >ğŸ”—</a><br>ã€ŒConverting RGB to LogLuv in a fragment shaderã€<a href="http://realtimecollisiondetection.net/blog/?p=15">ğŸ”—</a><br>ã€ŒRGBM color encodingã€<a href=http://graphicrants.blogspot.com/2009/04/rgbm-color-encoding.html>ğŸ”—</a><br>ã€Œç†è§£é«˜èŒƒå›´åŠ¨æ€å…‰ã€<a href=http://www.xionggf.com/articles/graphic/misc/inside_hdr.html>ğŸ”—</a><br>ã€ŒThree.js å®ç°ã€<a href=https://github.com/mrdoob/three.js/blob/master/examples/js/shaders/ToneMapShader.js>ğŸ”—</a><br>ã€ŒThree.js æ•ˆæœã€<a href=https://threejs.org/examples/#webgl_shaders_tonemapping>ğŸ”—</a><br><a href=http://examples.claygl.xyz/examples/basicPanoramaHDR.html>http://examples.claygl.xyz/examples/basicPanoramaHDR.html</a><h2 id=é—®é¢˜æè¿°>é—®é¢˜æè¿°</h2><p>äº®å¤„è¿‡æ›ï¼Œæš—å¤„å¤ªé»‘ä¸¢å¤±ç»†èŠ‚ã€‚<blockquote><p>The purpose of theÂ <strong>Tone Mapping</strong>Â function is to <strong>map the wide range of high dynamic range (HDR) colors into low dynamic range (LDR)</strong> that a display can output. This is the last stage of post processing that is done after the normal rendering during post processing.</blockquote><h2 id=æ‘„å½±å­¦ç»éªŒ>æ‘„å½±å­¦ç»éªŒ</h2><p>æ‘„å½±å­¦ä¸­å°† scene zone æ˜ å°„åˆ° print zoneï¼š<br><img src="https://intranetproxy.alipay.com/skylark/lark/0/2019/png/158945/1549000177768-2e3844da-ad35-40ae-bb7d-d0c9a8488f69.png#align=left&amp;display=inline&amp;height=329&amp;linkTarget=_blank&amp;name=%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202019-02-01%20%E4%B8%8B%E5%8D%881.49.10.png&amp;originHeight=752&amp;originWidth=1254&amp;size=144310&amp;width=549" alt="å±å¹•å¿«ç…§ 2019-02-01 ä¸‹åˆ1.49.10.png"><br>æœ¯è¯­<ul><li><strong>åŠ¨æ€èŒƒå›´ Dynamic range</strong>: In computer graphics the dynamic range of a scene is expressed as the ratio of the highest scene luminance to the lowest scene luminance<li><strong>åŸºè°ƒï¼ŸKey</strong>: The key of a scene indicates whether it is subjectively light, normal, or dark. A white-painted room would be high-key, and a dim stable would be low-key</ul><h2 id=reinhardåŸºç¡€ç®—æ³•>ReinhardÂ åŸºç¡€ç®—æ³•</h2><p>é¦–å…ˆè®¡ç®—å‡ºåœºæ™¯çš„åŸºè°ƒï¼ˆkeyï¼‰ï¼Œé€‰å– N ä¸ªåƒç´ ç‚¹çš„äº®åº¦è¿›è¡Œ log å¹³å‡ã€‚è¿™é‡ŒåŸè®ºæ–‡æœ‰ä¸€å¤„é”™è¯¯ <a href="https://www.phototalks.idv.tw/academic/?p=861">ğŸ”—</a>ï¼š<br><img src="https://intranetproxy.alipay.com/skylark/lark/__latex/f3afef1902f79ab793712a99f71bbdab.svg#card=math&amp;code=%5Cbar%7BL%7D_%7Bw%7D%20%3D%20exp%28%5Cfrac%7B1%7D%7BN%7D%5Csum_%7Bx%2Cy%7D%7Blog%28%5Cdelta%2B%20L_%7Bw%7D%28x%2Cy%29%29%7D%29&amp;height=49&amp;width=261" alt=""><br>è°ƒèŠ‚åƒç´ ç‚¹äº®åº¦æ—¶ï¼Œéœ€è¦ç”¨åˆ° a è¿™ä¸ªè¡¨ç¤º normal-key åŸºè°ƒçš„å€¼ï¼š<br><img src="https://intranetproxy.alipay.com/skylark/lark/__latex/abd81d03c129732392470442011970b0.svg#card=math&amp;code=L%28x%2Cy%29%20%3D%20%5Cfrac%7Ba%7D%7B%5Cbar%7BL%7D_%7Bw%7D%7DL_%7Bw%7D%28x%2Cy%29&amp;height=41&amp;width=163" alt=""><br>ä¸åŒ a å–å€¼æ•ˆæœå¦‚ä¸‹ï¼Œè¶Šå¤§è°ƒèŠ‚åè‡ªç„¶è¶Šäº®ï¼š<br><img src="https://intranetproxy.alipay.com/skylark/lark/0/2019/png/158945/1549003718743-b508b3af-2f0b-4f35-befc-d2e7cadf87b3.png#align=left&amp;display=inline&amp;height=285&amp;linkTarget=_blank&amp;name=%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202019-02-01%20%E4%B8%8B%E5%8D%882.48.08.png&amp;originHeight=732&amp;originWidth=1098&amp;size=182721&amp;width=428" alt="å±å¹•å¿«ç…§ 2019-02-01 ä¸‹åˆ2.48.08.png"><p>æ˜¾ç„¶è¿™ç§çº¿æ€§è°ƒèŠ‚çš„æ•ˆæœåœ¨å®é™…åº”ç”¨ä¸­æ˜¯æœ‰é—®é¢˜çš„ï¼ŒLwhite æ˜¯åœºæ™¯ä¸­çš„æœ€é«˜äº®åº¦ï¼š<br><img src="https://intranetproxy.alipay.com/skylark/lark/__latex/457d851c955e717fbeb8278d579b7149.svg#card=math&amp;code=L_%7Bd%7D%28x%2Cy%29%20%3D%20%5Cfrac%7BL%28x%2Cy%29%281%20%2B%20%5Cfrac%7BL%28x%2Cy%29%7D%7BL%5E%7B2%7D_%7Bwhite%7D%7D%29%7D%7B1%2BL%28x%2Cy%29%7D&amp;height=65&amp;width=222" alt=""><p>ä½†æ˜¯ä»ä¸å®Œç¾ï¼Œå°¤å…¶æ˜¯åœ¨å¾ˆé«˜åŠ¨æ€èŒƒå›´çš„åœºæ™¯ä¸‹ï¼Œä¾ç„¶ä¼šä¸¢å¤±ç»†èŠ‚ã€‚<h2 id=æ”¹è¿›>æ”¹è¿›</h2><p>ä½œè€…è§‚å¯Ÿåˆ°ï¼Œåœ¨ä¼ ç»Ÿæ‰“å°æŠ€æœ¯ä¸­ï¼Œä¸ºäº†æé«˜æ‰“å°ç»“æœçš„è´¨é‡ï¼Œé€šå¸¸ä¼šé‡‡ç”¨ä¸€ç§ dodying-and-burning çš„æ–¹æ³•ã€‚è¯¥æ–¹æ³•çš„åŸç†æ˜¯æ ¹æ®æ‰“å°å†…å®¹çš„ä¸åŒï¼Œåœ¨ä¸åŒåŒºåŸŸå‡å°‘å…‰äº®åº¦ï¼ˆdodyingï¼‰æˆ–è€…å¢åŠ å…‰äº®åº¦ï¼ˆburningï¼‰ã€‚<p>æ‰€ä»¥å…³é”®æ˜¯å¯¹äºåœºæ™¯çš„åŸºè°ƒçš„è®¡ç®—ã€‚<br>åŸè®ºæ–‡ä¸­é¦–å…ˆæ‰¾å‡ºå¯¹æ¯”åº¦å¤§çš„è¾¹ç¼˜åŒ…å›´çš„åŒºåŸŸï¼Œç„¶åå¯¹è¯¥åŒºåŸŸè¿›è¡Œå¤„ç†ã€‚<blockquote><p>å°‹æ‰¾å€åŸŸäº®åº¦VVä»¥å¼·åŒ–äº®éƒ¨å£“ç¸®çš„ç´°ç¯€å°±æ˜¯è©²è«–æ–‡é‡é»ã€‚è«–æ–‡ä¸­ä»¥DoG (difference of Gaussian)å¯¦ä½œã€‚ç•¶Vå’ŒLç›¸å·®è¼ƒå¤§æ™‚å‰‡æœƒä¿ç•™ç´°ç¯€ã€‚é€™è£¡ç”¨åˆ°Blob detectionçš„æŠ€å·§ï¼Œåˆ©ç”¨DoGæˆ–LoG (Laplician of Gaussian)ä¾†åµæ¸¬ä¸€å€‹åˆé©çš„feature scale (åœ¨<a href=http://en.wikipedia.org/wiki/Scale-invariant_feature_transform>SIFT</a>ä¸­æœ€å»£ç‚ºäººçŸ¥)ï¼Œåœ¨é€™è£¡æ˜¯å°‹æ‰¾ä¸€å€‹ä»¥ L ç‚ºä¸­å¿ƒçš„æœ€å¤§å€å¡Šä½¿å¾—å…§éƒ¨çš„äº®åº¦æœ€æ¥è¿‘ï¼Œä¸¦ä¸”è©²å€å¡Šæ²’æœ‰é¡¯è‘—çš„gradientè®ŠåŒ–ã€‚</blockquote><p>å› æ­¤ï¼Œä½œè€…æå‡ºåˆ©ç”¨é«˜æ–¯æ ¸å·ç§¯çš„æ–¹æ³•æ¥æ‰¾å‡ºè¿™äº›åŒºåŸŸã€‚<br><h2 id=webgl-å®ç°>WebGL å®ç°</h2><h3 id=åŸºç¡€ç‰ˆæœ¬-hdr>åŸºç¡€ç‰ˆæœ¬ HDR</h3><p>å…ˆæ¥çœ‹åŸºç¡€ç®—æ³•çš„å®ç°ï¼š<div><pre class=line-numbers data-line=""><code class=language-glsl>uniform float averageLuminance; // åœºæ™¯ä¸­çš„å¹³å‡äº®åº¦ï¼Œé»˜è®¤å€¼ 1.0
uniform float middleGrey; // å…¬å¼ä¸­çš„ aï¼Œé»˜è®¤å€¼ 0.6
uniform float minLuminance; // é»˜è®¤å€¼ 0.01
uniform float maxLuminance; // é»˜è®¤å€¼ 16

vec3 ToneMap( vec3 vColor ) {
  #ifdef ADAPTED_LUMINANCE
  // åŠ¨æ€è®¡ç®—åœºæ™¯åŸºè°ƒ
  float fLumAvg = texture2D(luminanceMap, vec2(0.5, 0.5)).r;
  #else
  // åŸºç¡€ç®—æ³•
  float fLumAvg = averageLuminance;
  #endif

  // è®¡ç®—é¢œè‰²å¯¹åº”çš„ç›¸å¯¹äº®åº¦ï¼Œå…¬å¼ä¸­çš„ Lw(x,y)
  float fLumPixel = linearToRelativeLuminance( vColor );
	
  // é¦–å…ˆè¿›è¡Œçº¿æ€§è°ƒèŠ‚
  float fLumScaled = (fLumPixel * middleGrey) / max( minLuminance, fLumAvg );
	
  // å¼•å…¥ Lwhite
  float fLumCompressed = (fLumScaled * (1.0 + (fLumScaled / (maxLuminance * maxLuminance)))) / (1.0 + fLumScaled);
  return fLumCompressed * vColor;
}</code></pre></div><p>è¿™é‡Œæ¶‰åŠåˆ°äº®åº¦çš„è®¡ç®—ï¼ŒRGB è‰²å½©ç©ºé—´åˆ° CIEï¼š<img src="https://intranetproxy.alipay.com/skylark/lark/0/2019/svg/158945/1549007595479-a39da1c0-9115-4cfc-adf4-3677cc82d604.svg#align=left&amp;display=inline&amp;height=27&amp;linkTarget=_blank&amp;originHeight=21&amp;originWidth=323&amp;size=0&amp;width=420" alt=""><div><pre class=line-numbers data-line=""><code class=language-glsl>// https://en.wikipedia.org/wiki/Relative_luminance
float linearToRelativeLuminance( const in vec3 color ) {
	vec3 weights = vec3( 0.2126, 0.7152, 0.0722 );
	return dot( weights, color.rgb );
}</code></pre></div><h3 id=adaptive-hdr>Adaptive HDR</h3><p>ä¸‹é¢æ¥çœ‹æ”¹è¿›ç‰ˆï¼Œå¹¶æ²¡æœ‰ä½¿ç”¨åŸè®ºæ–‡ä¸­å·ç§¯çš„æ–¹å¼ã€‚<p>é¦–å…ˆéœ€è¦å¼€å¯ OES_texture_float æ‰©å±•ï¼Œè®©æµ®ç‚¹å¸§ç¼“å†²å¯ä»¥å­˜å‚¨è¶…è¿‡ 0.0 åˆ° 1.0 èŒƒå›´çš„æµ®ç‚¹å€¼ã€‚<div><pre class=line-numbers data-line=""><code class=language-javascript>// å¼€å¯æ‰©å±•
if ( renderer.extensions.get( &#39;OES_texture_half_float_linear&#39; ) ) {
	parameters.type = THREE.FloatType;
}
// åˆ›å»ºåŠ¨æ€ HDR RenderTarget
var hdrRenderTarget = new THREE.WebGLRenderTarget( windowThirdX, height, parameters );</code></pre></div><p>åå¤„ç†ä¸­æˆ‘ä»¬åªéœ€è¦å…³æ³¨Â AdaptiveToneMappingPassï¼š<div><pre class=line-numbers data-line=""><code class=language-javascript>var adaptToneMappingPass = new THREE.AdaptiveToneMappingPass( true, 256 );
adaptToneMappingPass.needsSwap = true;
// å…¨å±€è¾‰å…‰
var bloomPass = new THREE.BloomPass();
// gamma æ ¡æ­£
var gammaCorrectionPass = new THREE.ShaderPass( THREE.GammaCorrectionShader );
gammaCorrectionPass.renderToScreen = true;</code></pre></div><p>åŸè®ºæ–‡ä¸­ä½¿ç”¨å·ç§¯è¿ç®—ååˆ†å¤æ‚ï¼ŒThree.js ä½¿ç”¨äº†ä¸€ç§ç›¸å¯¹ç®€å•åŸºäºæ—¶é—´çš„æ–¹æ¡ˆï¼š<br>é¦–å…ˆåˆå§‹åŒ–ä¸‰ä¸ª RTï¼š<div><pre class=line-numbers data-line=""><code class=language-javascript>// https://github.com/mrdoob/three.js/blob/master/examples/js/postprocessing/AdaptiveToneMappingPass.js

this.luminanceRT = new THREE.WebGLRenderTarget( this.resolution, this.resolution, pars );
this.luminanceRT.texture.name = &quot;AdaptiveToneMappingPass.l&quot;;
this.luminanceRT.texture.generateMipmaps = false;

this.previousLuminanceRT = new THREE.WebGLRenderTarget( this.resolution, this.resolution, pars );
this.previousLuminanceRT.texture.name = &quot;AdaptiveToneMappingPass.pl&quot;;
this.previousLuminanceRT.texture.generateMipmaps = false;

// We only need mipmapping for the current luminosity because we want a down-sampled version to sample in our adaptive shader
pars.minFilter = THREE.LinearMipMapLinearFilter;
pars.generateMipmaps = true;
this.currentLuminanceRT = new THREE.WebGLRenderTarget( this.resolution, this.resolution, pars );
this.currentLuminanceRT.texture.name = &quot;AdaptiveToneMappingPass.cl&quot;;</code></pre></div><p>ç„¶åè¾“å‡ºäº®åº¦åˆ°Â currentLuminanceRT ä¸­ï¼š<div><pre class=line-numbers data-line=""><code class=language-javascript>// ç®€å•è°ƒç”¨ linearToRelativeLuminance çš„ Shader
this.quad.material = this.materialLuminance;
this.materialLuminance.uniforms.tDiffuse.value = readBuffer.texture;
renderer.render( this.scene, this.camera, this.currentLuminanceRT );</code></pre></div><p>ç„¶åå–å¾—å½“å‰å¸§åˆ°ä¸Šä¸€å¸§çš„å·®å€¼ï¼Œè¿åŒÂ previousLuminanceRT ä¸€èµ·ä¼ å…¥Â AdaptiveShader ä¸­ï¼Œè¾“å‡ºç»“æœåˆ° luminanceRT ä¸­ï¼š<div><pre class=line-numbers data-line=""><code class=language-javascript>this.materialAdaptiveLum.uniforms.delta.value = deltaTime;
this.materialAdaptiveLum.uniforms.lastLum.value = this.previousLuminanceRT.texture;
this.materialAdaptiveLum.uniforms.currentLum.value = this.currentLuminanceRT.texture;
renderer.render( this.scene, this.camera, this.luminanceRT );</code></pre></div><p>æœ€åæ‹·è´è®¡ç®—ç»“æœÂ luminanceRT åˆ°Â previousLuminanceRTï¼Œå®Œæˆå½“å‰æ¸²æŸ“ passï¼š<div><pre class=line-numbers data-line=""><code class=language-javascript>this.quad.material = this.materialCopy;
this.copyUniforms.tDiffuse.value = this.luminanceRT.texture;
renderer.render( this.scene, this.camera, this.previousLuminanceRT );</code></pre></div><p>æ‰€ä»¥å…³é”®å°±åœ¨Â AdaptiveShader çš„å®ç°ï¼Œå¦‚ä½•è®¡ç®—å‡ºæ¯ä¸ª fragment çš„äº®åº¦ã€‚<br>è¿™é‡Œä½¿ç”¨äº†ä¸Šä¸€å¸§çš„äº®åº¦åŠ ä¸Šå½“å‰å¸§çš„å·®å€¼ä¹˜ä»¥ä¸€ä¸ªåŸºäºæ—¶é—´çš„ç³»æ•°ï¼š<div><pre class=line-numbers data-line=""><code class=language-glsl>uniform sampler2D lastLum; // ä¸Šä¸€å¸§äº®åº¦
uniform sampler2D currentLum; // å½“å‰å¸§äº®åº¦
uniform float minLuminance; // 0.01
uniform float delta; // 0.016
uniform float tau; // 1.0

void main() {

    vec4 lastLum = texture2D( lastLum, vUv, MIP_LEVEL_1X1 );
    vec4 currentLum = texture2D( currentLum, vUv, MIP_LEVEL_1X1 );

    float fLastLum = max( minLuminance, lastLum.r );
    float fCurrentLum = max( minLuminance, currentLum.r );

    //The adaption seems to work better in extreme lighting differences
    //if the input luminance is squared.
    fCurrentLum *= fCurrentLum;

    // Adapt the luminance using Pattanaik&#39;s technique
    float fAdaptedLum = fLastLum + (fCurrentLum - fLastLum) * (1.0 - exp(-delta * tau));
    gl_FragColor.r = fAdaptedLum;
}</code></pre></div><p>å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œæ³¨é‡Šä¸­æåˆ°ä½¿ç”¨çš„æ˜¯Â Pattanaik çš„æ¨¡å‹ï¼Œä½†æ˜¯æˆ‘åœ¨ç½‘ä¸ŠæŸ¥äº†ä¸‹ï¼Œä¹Ÿåªæ‰¾åˆ°<a href=http://www.cs.ucf.edu/~sumant/publications/sig00.pdf>è¿™ä¸€ç¯‡</a>ï¼Œé‡Œé¢å¹¶æ²¡æœ‰å…·ä½“çš„ç®—æ³•å…¬å¼ã€‚ç›´åˆ°åæ¥åœ¨çŸ¥ä¹ä¸Šè¯»åˆ°ã€Œ<a href=https://zhuanlan.zhihu.com/p/21983679>Tone mappingè¿›åŒ–è®º</a>ã€ï¼Œé‡Œé¢æåˆ°äº†ç”¨ exp æ¥æ¨¡æ‹Ÿ S æ›²çº¿ï¼ˆReinhard æ”¹è¿›ç‰ˆæ›²çº¿ä¹Ÿæ˜¯ S å‹ï¼‰ï¼Œæ‰ç†è§£åˆ°è¿™ä¸ªç³»æ•°çš„ç”±æ¥ï¼š<div><pre class=line-numbers data-line=""><code class=language-glsl>float3 CEToneMapping(float3 color, float adapted_lum) 
{
    return 1 - exp(-adapted_lum * color);
}</code></pre></div><h2 id=filmic-tonemapping>Filmic Tonemapping</h2><blockquote><p>è¿™ä¸ªæ–¹æ³•çš„æœ¬è´¨æ˜¯æŠŠåŸå›¾å’Œè®©è‰ºæœ¯å®¶ç”¨ä¸“ä¸šç…§ç›¸è½¯ä»¶æ¨¡æ‹Ÿèƒ¶ç‰‡çš„æ„Ÿè§‰ï¼Œäººè‚‰ tone mapping åçš„ç»“æœå»åšæ›²çº¿æ‹Ÿåˆï¼Œå¾—åˆ°ä¸€ä¸ªé«˜æ¬¡æ›²çº¿çš„è¡¨è¾¾å¼ã€‚è¿™æ ·çš„è¡¨è¾¾å¼åº”ç”¨åˆ°æ¸²æŸ“ç»“æœåï¼Œå°±èƒ½åœ¨å¾ˆå¤§ç¨‹åº¦ä¸Šè‡ªåŠ¨æ¥è¿‘äººå·¥è°ƒæ•´çš„ç»“æœã€‚</blockquote><p>åŸä½œè€…åœ¨ã€ŒFilmic Tonemapping Operatorsã€<a href=http://filmicworlds.com/blog/filmic-tonemapping-operators/ >ğŸ”—</a>æ–‡ç« ä¸­è¯¦ç»†ä»‹ç»äº†ä¸€äº›äººå·¥è°ƒæ•´ï¼Œæ‹Ÿåˆå‚æ•°çš„é€‰æ‹©ã€‚<br>clay.gl ä¸­ä¹Ÿæ›¾ç»é‡‡ç”¨è¿‡ï¼Œä¸è¿‡ç›®å‰ HDR çš„å®ç°é€‰æ‹©äº†å¦ä¸€ç§ ACESï¼Œåé¢ä¼šä»‹ç»ã€‚<p>æ–‡ç« ä¸­ä»‹ç»äº†å‡ ç§å®ç°ï¼š<blockquote><p>Next up is the optimized formula by Jim Hejl and Richard Burgess-Dawson. I completely forgot about Richard in the GDC talk, but he shares the credit with Jim</blockquote><div><pre class=line-numbers data-line=""><code class=language-glsl>// hdr.glsl

vec3 filmicToneMap(vec3 color)
{
    vec3 x = max(vec3(0.0), color - 0.004);
    return (x*(6.2*x+0.5))/(x*(6.2*x+1.7)+0.06);
}</code></pre></div><p>åŸä½œè€…çš„å®ç°ï¼š<div><pre class=line-numbers data-line=""><code class=language-glsl>// hdr.glsl

const vec3 whiteScale = vec3(11.2);

vec3 uncharted2ToneMap(vec3 x)
{
    const float A = 0.22;   // Shoulder Strength
    const float B = 0.30;   // Linear Strength
    const float C = 0.10;   // Linear Angle
    const float D = 0.20;   // Toe Strength
    const float E = 0.01;   // Toe Numerator
    const float F = 0.30;   //Toe Denominator

    return ((x*(A*x+C*B)+D*E)/(x*(A*x+B)+D*F))-E/F;
}

vec3 color = uncharted2ToneMap(tex) / uncharted2ToneMap(whiteScale);</code></pre></div><blockquote><p>è¿™ä¸ªæ–¹æ³•å¼€å¯äº† tone mapping çš„æ–°è·¯å¾„ï¼Œè®©äººä»¬çŸ¥é“äº†æ›²çº¿æ‹Ÿåˆçš„å¥½å¤„ã€‚å¹¶ä¸”ï¼Œå…¶ä»–é¢œè‰²ç©ºé—´çš„å˜æ¢ï¼Œæ¯”å¦‚gamma çŸ«æ­£ï¼Œä¹Ÿå¯ä»¥ä¸€èµ·åˆå¹¶åˆ°è¿™ä¸ªæ›²çº¿é‡Œæ¥ï¼Œä¸€æ¬¡æå®šï¼Œä¸ä¼šå¢åŠ é¢å¤–å¼€é”€ã€‚ç¼ºç‚¹å°±æ˜¯è¿ç®—é‡æœ‰ç‚¹å¤§ï¼Œä¸¤ä¸ªå¤šé¡¹å¼çš„è®¡ç®—ï¼Œå¹¶ä¸”ç›¸é™¤ã€‚</blockquote><p><br><h2 id=aces>ACES</h2><p>æ¥è‡ª Oscar ä¸“ä¸šç”µå½±å›¢é˜Ÿçš„æˆæœï¼š<blockquote><p>ä»–ä»¬å‘æ˜çš„ä¸œè¥¿å«<a href="http://link.zhihu.com/?target=http%3A//www.oscars.org/science-technology/sci-tech-projects/aces">Academy Color Encoding Systemï¼ˆACESï¼‰</a>ï¼Œæ˜¯ä¸€å¥—é¢œè‰²ç¼–ç ç³»ç»Ÿï¼Œæˆ–è€…è¯´æ˜¯ä¸€ä¸ªæ–°çš„é¢œè‰²ç©ºé—´ã€‚å®ƒæ˜¯ä¸€ä¸ªé€šç”¨çš„æ•°æ®äº¤æ¢æ ¼å¼ï¼Œä¸€æ–¹é¢å¯ä»¥ä¸åŒçš„è¾“å…¥è®¾å¤‡è½¬æˆACESï¼Œå¦ä¸€æ–¹é¢å¯ä»¥æŠŠACESåœ¨ä¸åŒçš„æ˜¾ç¤ºè®¾å¤‡ä¸Šæ­£ç¡®æ˜¾ç¤ºã€‚ä¸ç®¡ä½ æ˜¯LDRï¼Œè¿˜æ˜¯HDRï¼Œéƒ½å¯ä»¥åœ¨ACESé‡Œè¡¨è¾¾å‡ºæ¥ã€‚è¿™å°±ç›´æ¥è§£å†³äº†VDRçš„é—®é¢˜ï¼Œä¸åŒè®¾å¤‡é—´éƒ½å¯ä»¥äº’é€šæ•°æ®ã€‚ ç„¶è€Œå¯¹äºå®æ—¶æ¸²æŸ“æ¥è¯´ï¼Œæ²¡å¿…è¦ç”¨å…¨å¥—ACESã€‚å› ä¸ºç¬¬ä¸€ï¼Œæ²¡æœ‰ä»€ä¹ˆâ€œè¾“å…¥è®¾å¤‡â€ã€‚æ¸²æŸ“å‡ºæ¥çš„HDRå›¾åƒå°±æ˜¯ä¸ªçº¿æ€§çš„æ•°æ®ï¼Œæ‰€ä»¥ç›´æ¥å°±åœ¨ACESç©ºé—´ä¸­ã€‚è€Œè¾“å‡ºçš„æ—¶å€™éœ€è¦ä¸€æ¬¡tone mappingï¼Œè½¬åˆ°LDRæˆ–å¦ä¸€ä¸ªHDRã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬åªè¦ACESé‡Œçš„éå¸¸å°çš„ä¸€æ¡è·¯å¾„ï¼Œè€Œä¸æ˜¯çº·ç¹å¤æ‚çš„æ•´å¥—ä½“ç³»ã€‚</blockquote><p>ã€Œ<a href=https://knarkowicz.wordpress.com/2016/01/06/aces-filmic-tone-mapping-curve/ >ACES Filmic Tone MappingÂ Curve</a>ã€ä¸­æ‹Ÿåˆçš„ä¹Ÿæ˜¯ä¸€æ¡ S æ›²çº¿ï¼Œå¯è§å’Œä¸“ä¸šäººå£«æä¾›çš„æ›²çº¿ï¼ˆè™šçº¿ï¼‰é‡åˆåº¦å·²ç»å¾ˆé«˜äº†ï¼Œå› æ­¤ç°åœ¨ä¸»æµ 3D å¼•æ“ï¼ˆåŒ…æ‹¬ clay.glï¼‰HDR æ–¹æ¡ˆä¹Ÿéƒ½æ˜¯é€‰æ‹©çš„è¿™ç§æ–¹æ³•ï¼š<br><img src="https://intranetproxy.alipay.com/skylark/lark/0/2019/png/158945/1549021113086-4406fcdd-4612-45f3-9671-43b94c8cb82a.png#align=left&amp;display=inline&amp;height=166&amp;linkTarget=_blank&amp;originHeight=366&amp;originWidth=576&amp;size=0&amp;width=261" alt=""><div><pre class=line-numbers data-line=""><code class=language-glsl>vec3 ACESToneMapping(vec3 color)
{
    const float A = 2.51;
    const float B = 0.03;
    const float C = 2.43;
    const float D = 0.59;
    const float E = 0.14;
    return (color * (A * color + B)) / (color * (C * color + D) + E);
}</code></pre></div><h3 id=unreal-ä¸­çš„å®ç°>Unreal ä¸­çš„å®ç°</h3><p><a href=https://docs.unrealengine.com/en-us/Engine/Rendering/PostProcessEffects/ColorGrading>https://docs.unrealengine.com/en-us/Engine/Rendering/PostProcessEffects/ColorGrading</a><blockquote><p>As of Unreal Engine version 4.15, the filmic tone mapper was enabled as the <strong>default tone mapper</strong>.</blockquote><p>æ‹Ÿåˆ S æ›²çº¿çš„åœ¨çº¿å±•ç¤ºï¼š<br><a href=https://www.desmos.com/calculator/h8rbdpawxj>https://www.desmos.com/calculator/h8rbdpawxj</a><h3 id=æ›å…‰åº¦>æ›å…‰åº¦</h3><p>æ›å…‰åº¦æ˜¯å¯ä»¥è°ƒèŠ‚çš„ï¼Œå½“è¶…è¿‡é»˜è®¤å€¼ 1 æ—¶ï¼ŒToneMapping ä¼šå°† HDR æ˜ å°„åˆ° LDRã€‚<br>ä»¥ä¸‹æ˜¯ clay.gl ä¸­çš„å®ç°ï¼š<div><pre class=line-numbers data-line=""><code class=language-glsl>uniform float exposure : 1.0;

// Adjust exposure
// From KlayGE
#ifdef LUM_ENABLED
    float fLum = texture2D(lum, vec2(0.5, 0.5)).r;
    float adaptedLumDest = 3.0 / (max(0.1, 1.0 + 10.0*eyeAdaption(fLum)));
    float exposureBias = adaptedLumDest * exposure;
#else
    float exposureBias = exposure;
#endif

// åº”ç”¨æ›å…‰åº¦è¿›å…¥ HDR
texel.rgb *= exposureBias;
// é€šè¿‡ ACES ToneMapping æ˜ å°„æˆ LDR
texel.rgb = ACESToneMapping(texel.rgb);</code></pre></div><p>æ¥è‡ª Unreal åŒæ ·æ›å…‰åº¦è®¾ä¸º 3ï¼Œåº”ç”¨äº† ACES ä¹‹åï¼ˆå·¦ä¾§ï¼‰æ˜æ˜¾æ¯”è€ç‰ˆæœ¬çš„ ToneMapping ï¼ˆå³ä¾§ï¼‰ä¿ç•™äº†æ›´å¤šç»†èŠ‚ï¼š<br><img src="https://intranetproxy.alipay.com/skylark/lark/0/2019/png/158945/1549519347047-9e150ee0-2f35-4bda-a5da-66b8caeff4b5.png#align=left&amp;display=inline&amp;height=209&amp;linkTarget=_blank&amp;originHeight=842&amp;originWidth=1278&amp;size=0&amp;width=317" alt=""><img src="https://intranetproxy.alipay.com/skylark/lark/0/2019/png/158945/1549519346930-507e21de-1cb3-402d-b272-198e67e906c8.png#align=left&amp;display=inline&amp;height=208&amp;linkTarget=_blank&amp;originHeight=842&amp;originWidth=1278&amp;size=0&amp;width=316" alt=""><h2 id=rgbm>RGBM</h2><p>ç°åœ¨æˆ‘ä»¬æœ‰äº†å„ç§å„æ ·çš„ Tone Mapping ç®—æ³•ï¼Œé‚£ä¹ˆä¸€ä¸ªå…³é”®çš„é—®é¢˜æ˜¯ï¼Œå¦‚ä½•å­˜å‚¨è¿™äº›è¶…å‡º 0 -255 èŒƒå›´çš„ RGB é¢œè‰²å€¼å‘¢ï¼Ÿ<p>å…ˆæ¥çœ‹çœ‹ clay.gl ä¸­æ˜¯æ€ä¹ˆåšçš„ï¼Œåœ¨éœ€è¦ä½¿ç”¨ HDR çš„åœ°æ–¹æä¾›äº† decode å’Œ encode å‡½æ•°ï¼š<div><pre class=line-numbers data-line=""><code class=language-glsl>@export clay.util.rgbm
@import clay.util.rgbm_decode
@import clay.util.rgbm_encode

vec4 decodeHDR(vec4 color)
{
#if defined(RGBM_DECODE) || defined(RGBM)
    return vec4(RGBMDecode(color, 8.12), 1.0);
#else
    return color;
#endif
}

vec4 encodeHDR(vec4 color)
{
#if defined(RGBM_ENCODE) || defined(RGBM)
    return RGBMEncode(color.xyz, 8.12);
#else
    return color;
#endif
}

@end</code></pre></div><p>é‚£ä¹ˆè¿™é‡Œçš„ RGBM åˆæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿä¸‹é¢å°±é€šè¿‡ä»¥ä¸‹ä¸¤ç¯‡æ–‡ç« æ¥äº†è§£ä¸€ä¸‹ï¼š<ul><li>ã€ŒConverting RGB to LogLuv in a fragment shaderã€<a href="http://realtimecollisiondetection.net/blog/?p=15">ğŸ”—</a><li>ã€ŒRGBM color encodingã€<a href=http://graphicrants.blogspot.com/2009/04/rgbm-color-encoding.html>ğŸ”—</a></ul><p>ç›¸è¾ƒÂ LogLuv æ¶‰åŠçš„ log è¿ç®—ï¼ŒRGBM ç¼–ç æ—¶åœ¨ a åˆ†é‡ä¸­å­˜å‚¨çš„æ˜¯äº®åº¦çš„ rangeï¼Œå› æ­¤ decode æ—¶ç‰¹åˆ«ç®€å•ã€‚<br>å…³äºè¿™ä¸ª range çš„å€¼ï¼ŒåŸç‰ˆä¸­å®šä¹‰ä¸º 6ï¼Œclay.gl ä¸­åˆ™å®šä¹‰ä¸º 8.12ï¼š<div><pre class=line-numbers data-line=""><code class=language-glsl>@export clay.util.rgbm_decode
vec3 RGBMDecode(vec4 rgbm, float range) {
  return range * rgbm.rgb * rgbm.a;
}
@end

@export clay.util.rgbm_encode
vec4 RGBMEncode(vec3 color, float range) {
    if (dot(color, color) == 0.0) {
        return vec4(0.0);
    }
    vec4 rgbm;
    color /= range;
    rgbm.a = clamp(max(max(color.r, color.g), max(color.b, 1e-6)), 0.0, 1.0);
    rgbm.a = ceil(rgbm.a * 255.0) / 255.0;
    rgbm.rgb = color / rgbm.a;
    return rgbm;
}
@end</code></pre></div><p>å½“ç„¶é™¤äº†è¿™ä¸¤ç§ç¼–ç æ–¹å¼ï¼Œè¿˜æœ‰Â <a href=http://lousodrome.net/blog/light/tag/rgbm/ >http://lousodrome.net/blog/light/tag/rgbm/</a>Â ä¸­æåˆ°çš„ RGBE ç­‰è‹¥å¹²ç§ã€‚</article><div class=social-share-wrapper><div class=social-share></div></div></div><section class=author-detail><section class="post-footer-item author-card"><div class=avatar><img src=https://xiaoiver.github.io/assets/img/avatar.jpg alt=""></div><div class=author-name rel=author>æ½˜å®‡çª</div><div class=bio><p>åˆ†äº«å†™ä»£ç ï¼Œå¬éŸ³ä¹ï¼Œçœ‹ç”µå½±çš„å¿ƒå¾—</div><ul class=sns-links><li><a href=//github.com/xiaoiver target=_blank><i class="iconfont icon-github"></i></a><li><a href=//www.douban.com/people/150275082/ target=_blank><i class="iconfont icon-douban"></i></a><li><a href=//www.zhihu.com/people/pan-yu-qi-20/activities target=_blank><i class="iconfont icon-zhihu"></i></a></ul></section><section class="post-footer-item read-next"><div class=read-next-item><a href=/coding/2019/02/06/Lensflare.html class=read-next-link></a><section><span>Lensflare</span><p>webgl_lensflarespseudo-lens-flare</section><div class=filter></div><img src="https://intranetproxy.alipay.com/skylark/lark/0/2019/png/158945/1549443420530-b4e0077f-c0a0-417a-862f-8f75b758d375.png#align=left&display=inline&height=798&linkTarget=_blank&name=image.png&originHeight=1596&originWidth=2778&size=3578605&width=1389" alt=""></div><div class=read-next-item><a href=/coding/2019/02/03/%E5%8F%8D%E8%B5%B0%E6%A0%B7%E6%8A%80%E6%9C%AF-%E5%9B%9B.html class=read-next-link></a><section><span>åèµ°æ ·æŠ€æœ¯ï¼ˆå››ï¼‰</span><p>ç°åœ¨æˆ‘ä»¬å·²ç»äº†è§£äº†åŸºäºå½¢æ€å­¦çš„åèµ°æ ·æŠ€æœ¯ MLAA/SMAA å’Œ FXAAï¼Œä¹Ÿäº†è§£äº†æ‹¥æœ‰ç¡¬ä»¶æ”¯æŒçš„ MSAAã€‚ä¸¥æ ¼...</section><div class=filter></div><img src=/assets/img/webgl/quaternion.jpg alt=""></div></section><section class="post-footer-item comment"><hr><div class=container id=lv-container data-id=city data-uid=MTAyMC8zMDQyNy82OTgx><script>(function(d, s) {
       var j, e = d.getElementsByTagName(s)[0];

       if (typeof LivereTower === 'function') { return; }

       j = d.createElement(s);
       j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
       j.async = true;

       e.parentNode.insertBefore(j, e);
   })(document, 'script');</script><noscript>ä¸ºæ­£å¸¸ä½¿ç”¨æ¥å¿…åŠ›è¯„è®ºåŠŸèƒ½è¯·æ¿€æ´»JavaScript</noscript></div></section></section><footer class=g-footer><section>xiaOpçš„åšå®¢ Â© 2019</section><section>Powered by <a href=//jekyllrb.com>Jekyll</a> | <a href=https://github.com/kaeyleo/jekyll-theme-H2O>Theme H2O</a></section></footer><div class=update-toast><span class=update-toast-text>ç«™ç‚¹å‘ç”Ÿæ›´æ–°ï¼Œè¯·æ‰‹åŠ¨åˆ·æ–°</span> <span class=update-toast-refresh-btn></span></div><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><script src=/assets/js/social-share.min.js></script><script>socialShare('.social-share', {
        sites: ['wechat','weibo','douban','twitter'],
        wechatQrcodeTitle: "åˆ†äº«åˆ°å¾®ä¿¡æœ‹å‹åœˆ",
        wechatQrcodeHelper: '<p>æ‰«ç åç‚¹å‡»å³ä¸Šè§’</p><p>å°†æœ¬æ–‡åˆ†äº«è‡³æœ‹å‹åœˆ</p>'
    });</script><script src=/assets/js/prism.min.js></script><script src=/assets/js/index.min.js></script><script src=/assets/js/jquery.nav.js></script><script>function generateCatalog (selector) {
        // init
        var P = $('.markdown-body'),a,n,t,l,i,c;
        a = P.find('h1,h2,h3,h4,h5,h6');

        // clean
        $(selector).html('')

        // appending
        a.each(function () {
            n = $(this).prop('tagName').toLowerCase();
            i = "#"+$(this).prop('id');
            t = $(this).text();
            c = $('<a href="'+i+'" rel="nofollow">'+t+'</a>');
            l = $('<li class="'+n+'_nav"></li>').append(c);
            $(selector).append(l);
        });
        return true;
    }

    generateCatalog(".catalog-body");

    // toggle side catalog
    $(".catalog-toggle").click((function(e){
        e.preventDefault();
        $('.side-catalog').toggleClass("fold")
    }))

    /*
     * Doc: https://github.com/davist11/jQuery-One-Page-Nav
     * Fork by Hux to support padding
     */
    $('.catalog-body').onePageNav({
        currentClass: "active",
        changeHash: !1,
        easing: "swing",
        filter: "",
        scrollSpeed: 700,
        scrollOffset: 0,
        scrollThreshold: .2,
        begin: null,
        end: null,
        scrollChange: null,
        padding: 80
    });</script><script>window.onload = function () {
                    var script = document.createElement('script');
                    var firstScript = document.getElementsByTagName('script')[0];
                    script.type = 'text/javascript';
                    script.async = true;
                    script.src = '/sw-register.js?v=' + Date.now();
                    firstScript.parentNode.insertBefore(script, firstScript);
                };</script>