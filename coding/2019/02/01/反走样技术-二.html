<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åèµ°æ ·æŠ€æœ¯ï¼ˆäºŒï¼‰ - xiaOpçš„åšå®¢</title>
    <meta name="author"  content="æ½˜å®‡çª">
    <meta name="description" content="åèµ°æ ·æŠ€æœ¯ï¼ˆäºŒï¼‰">
    <meta name="keywords"  content="WebGL">

    <!-- Begin Jekyll SEO tag v2.4.0 -->
<title>åèµ°æ ·æŠ€æœ¯ï¼ˆäºŒï¼‰ | xiaOpçš„åšå®¢</title>
<meta name="generator" content="Jekyll v3.6.2" />
<meta property="og:title" content="åèµ°æ ·æŠ€æœ¯ï¼ˆäºŒï¼‰" />
<meta name="author" content="xiaOp" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="ã€ŒNvidia åŸç‰ˆ FXAA_WhitePaper.pdfã€ğŸ”— åèµ°æ ·æŠ€æœ¯æ€»ç»“ ã€ŒImplementing FXAAã€ğŸ”— Three.js FXAAShader.js" />
<meta property="og:description" content="ã€ŒNvidia åŸç‰ˆ FXAA_WhitePaper.pdfã€ğŸ”— åèµ°æ ·æŠ€æœ¯æ€»ç»“ ã€ŒImplementing FXAAã€ğŸ”— Three.js FXAAShader.js" />
<link rel="canonical" href="https://xiaoiver.github.io/coding/2019/02/01/%E5%8F%8D%E8%B5%B0%E6%A0%B7%E6%8A%80%E6%9C%AF-%E4%BA%8C.html" />
<meta property="og:url" content="https://xiaoiver.github.io/coding/2019/02/01/%E5%8F%8D%E8%B5%B0%E6%A0%B7%E6%8A%80%E6%9C%AF-%E4%BA%8C.html" />
<meta property="og:site_name" content="xiaOpçš„åšå®¢" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2019-02-01T00:00:00+08:00" />
<script type="application/ld+json">
{"description":"ã€ŒNvidia åŸç‰ˆ FXAA_WhitePaper.pdfã€ğŸ”— åèµ°æ ·æŠ€æœ¯æ€»ç»“ ã€ŒImplementing FXAAã€ğŸ”— Three.js FXAAShader.js","author":{"@type":"Person","name":"xiaOp"},"@type":"BlogPosting","url":"https://xiaoiver.github.io/coding/2019/02/01/%E5%8F%8D%E8%B5%B0%E6%A0%B7%E6%8A%80%E6%9C%AF-%E4%BA%8C.html","headline":"åèµ°æ ·æŠ€æœ¯ï¼ˆäºŒï¼‰","dateModified":"2019-02-01T00:00:00+08:00","datePublished":"2019-02-01T00:00:00+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://xiaoiver.github.io/coding/2019/02/01/%E5%8F%8D%E8%B5%B0%E6%A0%B7%E6%8A%80%E6%9C%AF-%E4%BA%8C.html"},"@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->


    <meta name="theme-color" content="#4acaa8">
    <meta name="msapplication-TileColor" content="#4acaa8">
    <meta name="msapplication-TileImage" content="/assets/img/manifest/ms-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="57x57" href="/assets/img/manifest/apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/assets/img/manifest/apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/assets/img/manifest/apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/assets/img/manifest/apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/assets/img/manifest/apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/assets/img/manifest/apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/assets/img/manifest/apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/assets/img/manifest/apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/assets/img/manifest/apple-icon-180x180.png">
    <link rel="icon" type="image/png" sizes="192x192"  href="/assets/img/manifest/android-icon-192x192.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/assets/img/manifest/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="96x96" href="/assets/img/manifest/favicon-96x96.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/assets/img/manifest/favicon-16x16.png">

    <link rel="shortcut icon" href="/assets/img/manifest/favicon.ico" type="image/x-icon">
    <link rel="canonical" href="https://xiaoiver.github.io/coding/2019/02/01/%E5%8F%8D%E8%B5%B0%E6%A0%B7%E6%8A%80%E6%9C%AF-%E4%BA%8C.html">
    <link rel="manifest" href="/manifest.json">

    <link rel="stylesheet" href="//cdn.staticfile.org/normalize/6.0.0/normalize.min.css">
    <link rel="stylesheet" href="//at.alicdn.com/t/font_roc50gemkxpw4s4i.css">
    <link rel="stylesheet" href="/assets/css/github-markdown.css">
    <link rel="stylesheet" href="/assets/css/prism.css">
    <link rel="stylesheet" href="/assets/css/share.min.css">
    <link rel="stylesheet" href="/assets/css/app.min.css">
    <link rel="stylesheet" href="/assets/css/post.min.css">

    

    <script src="https://cdn.staticfile.org/jquery/3.2.1/jquery.min.js"></script>
    <script src="/assets/js/Imager.min.js"></script>
    
    <script src="/assets/js/glsl-canvas.min.js"></script>
    <script>
        function initArrayBuffer(gl, program, attribute, data, type, num) {
            // Create a buffer object
            var buffer = gl.createBuffer();
            if (!buffer) {
                console.log('Failed to create the buffer object');
                return false;
            }
            // Write date into the buffer object
            gl.bindBuffer(gl.ARRAY_BUFFER, buffer);
            gl.bufferData(gl.ARRAY_BUFFER, data, gl.STATIC_DRAW);
            // Assign the buffer object to the attribute variable
            var a_attribute = gl.getAttribLocation(program, attribute);
            if (a_attribute < 0) {
                console.log('Failed to get the storage location of ' + attribute);
                return false;
            }
            gl.vertexAttribPointer(a_attribute, num, type, false, 0, 0);
            // Enable the assignment of the buffer object to the attribute variable
            gl.enableVertexAttribArray(a_attribute);

            gl.bindBuffer(gl.ARRAY_BUFFER, null);

            return true;
        }
    </script>
    
</head>

<body>
    <!--[if lt IE 10]>
<div class="alert-danger" role="alert">ä½ çš„æµè§ˆå™¨å®åœ¨å¤ªå¤ªå¤ªæ—§äº†ï¼Œæ”¾å­¦åˆ«èµ°ï¼Œå‡çº§å®Œæµè§ˆå™¨å†è¯´ï¼<a target="_blank" class="alert-link" href="http://browsehappy.com">ç«‹å³å‡çº§</a></div>
<![endif]-->
<input id="nm-switch" type="hidden" value="false">

<header class="g-header">
    <div class="g-logo">
      <a href="/"></a>
    </div>
    <i id="menu-toggle" class="iconfont icon-menu"></i>
    <nav class="g-nav">
        <ul>
            
            <li><a href="/">home</a></li>
            
            <li><a href="/tags.html">tags</a></li>
            
            <li><a href="/collectives.html">collectives</a></li>
            
        </ul>
    </nav>
</header>


<header class="g-banner post-header post-pattern-circuitBoard bgcolor-default " data-theme="default">
    <div class="post-wrapper">
        <div class="post-tags">
            
            
            <a href="https://xiaoiver.github.io/tags#WebGL" class="post-tag">WebGL</a>
            
            
        </div>
        <h1>åèµ°æ ·æŠ€æœ¯ï¼ˆäºŒï¼‰</h1>
        <div class="post-meta">
            <span class="post-meta-item"><i class="iconfont icon-author"></i><a href="https://xiaoiver.github.io" target="_blank" rel="author">xiaOp</a></span>
            <time class="post-meta-item" datetime="19-02-01"><i class="iconfont icon-date"></i>01 Feb 2019</time>
        </div>
    </div>
    
    <div class="filter"></div>
    <div class="post-cover" style="background: url('/assets/img/webgl/quaternion.jpg') center no-repeat; background-size: cover;">
    
</header>

<div class="post-content">
    <div class="catalog-container">
        <div class="side-catalog">
            <h3 class="catalog-title">
                <a class="catalog-toggle" href="#">CATALOG</a>
            </h3>
            <ul class="catalog-body"></ul>
        </div>
    </div>
    
    <h2 class="post-subtitle">åŸºäºå½¢æ€å­¦çš„æ–¹æ³• FXAA</h2>
    
    <article class="markdown-body">
        <ul>
  <li>ã€ŒNvidia åŸç‰ˆ FXAA_WhitePaper.pdfã€<a href="https://developer.download.nvidia.com/assets/gamedev/files/sdk/11/FXAA_WhitePaper.pdf">ğŸ”—</a></li>
  <li><a href="https://zhuanlan.zhihu.com/p/28800047">åèµ°æ ·æŠ€æœ¯æ€»ç»“</a></li>
  <li>ã€ŒImplementing FXAAã€<a href="http://blog.simonrodriguez.fr/articles/30-07-2016_implementing_fxaa.html">ğŸ”—</a></li>
  <li><a href="https://github.com/mrdoob/three.js/blob/master/examples/js/shaders/FXAAShader.js">Three.js FXAAShader.js</a></li>
</ul>

<p>æ¨èé˜…è¯»ã€ŒImplementing FXAAã€ï¼Œç›¸è¾ƒ nvidia åŸç‰ˆä»¥åŠ Three.js çš„å®ç°å¯è¯»æ€§è¦é«˜å¾ˆå¤šã€‚
å…¶ä»–å®ç°è¿˜æœ‰ clay.gl ä¸­çš„ <a href="https://github.com/pyalot/webgl-deferred-irradiance-volumes/blob/master/src/antialias/fxaa3_11_preprocessed.shaderlib">fxaa3.glsl</a></p>

<h2 id="ç®—æ³•æ€è·¯">ç®—æ³•æ€è·¯</h2>

<p>FXAA å’Œ MLAA ä»¥åŠ SMAA ä¸€æ ·ï¼Œéƒ½æ˜¯åŸºäºå‡ ä½•åèµ°æ ·çš„æ–¹æ³•ï¼ŒåŸºæœ¬æ­¥éª¤æ¥è‡ªåŸå§‹è®ºæ–‡ï¼Œå¯¹åº”ä¸‹é¢çš„ 8 å¼ å›¾ï¼š</p>
<ol>
  <li>non-linear RGB è¾“å…¥</li>
  <li>åŸºäºäº®åº¦çš„è¾¹ç¼˜æ£€æµ‹ï¼Œçº¢è‰²éƒ¨åˆ†</li>
  <li>æ£€æµ‹åˆ°çš„è¾¹ç¼˜æŒ‰æ°´å¹³å’Œå‚ç›´æ–¹å‘è¿›è¡Œåˆ†ç±»</li>
  <li>Given edge orientation, the highest contrast pixel pair 90 degrees to the edge is
selected, in blue/green</li>
  <li>æ²¿è¾¹ç¼˜æ–¹å‘å‘ä¸¤ä¾§ï¼ˆçº¢è‰²ä»£è¡¨è´Ÿå‘ï¼Œè“è‰²æ­£å‘ï¼‰æ£€æµ‹ï¼Œæ‰¾åˆ°äº®åº¦å˜åŒ–å¤§çš„ä¸€ç«¯</li>
  <li>Given the ends of the edge, pixel position on the edge is transformed into to a
sub-pixel shift 90 degrees perpendicular to the edge to reduce the aliasing,
red/blue for -/+ horizontal shift and gold/skyblue for -/+ vertical shift</li>
  <li>The input texture is re-sampled given this sub-pixel offset</li>
  <li>ä½¿ç”¨ä¸€ä¸ªä½é€šæ»¤æ³¢å™¨è¿›è¡Œæ¨¡ç³Šå¤„ç†</li>
</ol>

<p><img src="/assets/img/webgl/fxaa1.png" alt="å±å¹•å¿«ç…§ 2019-02-02 ä¸Šåˆ11.39.36.png" /></p>

<p>ä¸‹é¢ç»“åˆå…·ä½“å®ç°ã€‚</p>

<h2 id="è¾¹ç¼˜æ£€æµ‹">è¾¹ç¼˜æ£€æµ‹</h2>
<p>å’Œ MLAA &amp; SMAA ä¸€æ ·ï¼Œé¦–å…ˆéœ€è¦æ£€æµ‹è¾¹ç¼˜ã€‚</p>
<blockquote>
  <p>ä¸ºäº†æ›´å¥½çš„é€šç”¨æ€§ï¼ŒFXAA ä½¿ç”¨ sRGB ç©ºé—´çš„é¢œè‰²ä½œä¸ºè¾“å…¥ï¼Œå¹¶æ ¹æ®å±€éƒ¨çš„äº®åº¦å¯¹æ¯”åº¦æ¥ç¡®å®šä¸€ä¸ªåƒç´ æ˜¯å¦æ˜¯è¾¹ç¼˜åƒç´ ã€‚è¿™ä¹Ÿå°±æ˜¯è¡¨ç¤º FXAA ä¸€èˆ¬åº”è¯¥å‘ç”Ÿåœ¨ Tone Mapping ä¹‹åï¼Œæˆ–è€…ä¹Ÿå¯ä»¥æŠŠ Tone Mapping å’Œ FXAA æ•´åˆæˆä¸€ä¸ª passã€‚</p>
</blockquote>

<p>RGB æå–äº®åº¦ï¼Œä¹‹å‰åœ¨ HDR Tone Mapping ä¸­å·²ç»ä»‹ç»è¿‡äº†ã€‚å¦å¤–éœ€è¦æ³¨æ„ï¼Œè¿™é‡Œè¿›è¡Œäº† gamma æ ¡æ­£è½¬æ¢åˆ° sRGB ç©ºé—´ï¼Œè™½ç„¶åªæ˜¯ä¼°ç®—ï¼ˆsqrt çº¦ç­‰äº pow(1/2.2)ï¼‰ï¼š</p>
<div>
<pre class="line-numbers" data-line=""><code class="language-glsl">float rgb2luma(vec3 rgb){
    return sqrt(dot(rgb, vec3(0.299, 0.587, 0.114)));
}</code></pre>
</div>

<p>è¾¹ç¼˜æ£€æµ‹éƒ¨åˆ†å¾ˆç®€å•ï¼š</p>
<div>
<pre class="line-numbers" data-line=""><code class="language-glsl">vec3 colorCenter = texture(screenTexture,In.uv).rgb;

// å½“å‰ fragmentäº®åº¦
float lumaCenter = rgb2luma(colorCenter);

// ä¸Šä¸‹å·¦å³å››ä¸ªé‚»å±…äº®åº¦
float lumaDown = rgb2luma(textureOffset(screenTexture,In.uv,ivec2(0,-1)).rgb);
float lumaUp = rgb2luma(textureOffset(screenTexture,In.uv,ivec2(0,1)).rgb);
float lumaLeft = rgb2luma(textureOffset(screenTexture,In.uv,ivec2(-1,0)).rgb);
float lumaRight = rgb2luma(textureOffset(screenTexture,In.uv,ivec2(1,0)).rgb);

// æ‰¾åˆ°æœ€å¤§æœ€å°å€¼
float lumaMin = min(lumaCenter,min(min(lumaDown,lumaUp),min(lumaLeft,lumaRight)));
float lumaMax = max(lumaCenter,max(max(lumaDown,lumaUp),max(lumaLeft,lumaRight)));

// è®¡ç®—å·®å€¼
float lumaRange = lumaMax - lumaMin;

// ä½äºé˜ˆå€¼ï¼Œè·³è¿‡åç»­ FXAA å¤„ç†
if(lumaRange &lt; max(EDGE_THRESHOLD_MIN,lumaMax*EDGE_THRESHOLD_MAX)){
    fragColor = colorCenter;
    return;
}</code></pre>
</div>

<h2 id="è¾¹ç¼˜å½¢æ€">è¾¹ç¼˜å½¢æ€</h2>
<p>ç›¸è¾ƒ MLAA å¤šè¾¾ 16 ç§çš„è¾¹ç¼˜å½¢æ€ï¼Œè¾¹ç¼˜å½¢æ€åªç®€å•è€ƒè™‘æ°´å¹³å’Œå‚ç›´ä¸¤ç§ï¼š<br />ä¾‹å¦‚ horizontal:Â <code class="highlighter-rouge">|(upleft - left) - (left - downleft)| + 2 *Â |(up - center) - (center - down)| + |(upright - right) - (right - downright)|</code></p>
<div>
<pre class="line-numbers" data-line=""><code class="language-glsl">// å¯¹è§’çº¿
float lumaDownLeft = rgb2luma(textureOffset(screenTexture,In.uv,ivec2(-1,-1)).rgb);
float lumaUpRight = rgb2luma(textureOffset(screenTexture,In.uv,ivec2(1,1)).rgb);
float lumaUpLeft = rgb2luma(textureOffset(screenTexture,In.uv,ivec2(-1,1)).rgb);
float lumaDownRight = rgb2luma(textureOffset(screenTexture,In.uv,ivec2(1,-1)).rgb);

// æ°´å¹³å‚ç›´æ–¹å‘
float lumaDownUp = lumaDown + lumaUp;
float lumaLeftRight = lumaLeft + lumaRight;

// 4ä¸ªè§’
float lumaLeftCorners = lumaDownLeft + lumaUpLeft;
float lumaDownCorners = lumaDownLeft + lumaDownRight;
float lumaRightCorners = lumaDownRight + lumaUpRight;
float lumaUpCorners = lumaUpRight + lumaUpLeft;

// æ°´å¹³å‚ç›´æ–¹å‘è®¡ç®—å·®å€¼
float edgeHorizontal =  abs(-2.0 * lumaLeft + lumaLeftCorners)  + abs(-2.0 * lumaCenter + lumaDownUp ) * 2.0    + abs(-2.0 * lumaRight + lumaRightCorners);
float edgeVertical =    abs(-2.0 * lumaUp + lumaUpCorners)      + abs(-2.0 * lumaCenter + lumaLeftRight) * 2.0  + abs(-2.0 * lumaDown + lumaDownCorners);

// åˆ¤æ–­æ–¹å‘ï¼Œæ°´å¹³ or å‚ç›´
bool isHorizontal = (edgeHorizontal &gt;= edgeVertical);</code></pre>
</div>

<p>ç”±äºè¾¹ç¼˜å¯èƒ½ç»è¿‡åƒç´ ä¸¤ä¾§ï¼ˆå·¦å³ï¼Œä¸Šä¸‹ï¼‰ï¼Œéœ€è¦è¿›ä¸€æ­¥åˆ¤æ–­ï¼š</p>
<div>
<pre class="line-numbers" data-line=""><code class="language-glsl">// ä¸¤ä¾§é‚»å±…
float luma1 = isHorizontal ? lumaDown : lumaLeft;
float luma2 = isHorizontal ? lumaUp : lumaRight;
// å½“å‰æ–¹å‘ä¸Šçš„å·®å€¼
float gradient1 = luma1 - lumaCenter;
float gradient2 = luma2 - lumaCenter;

// å“ªè¾¹å·®å€¼æ›´å¤§ï¼Ÿ
bool is1Steepest = abs(gradient1) &gt;= abs(gradient2);

// ä½œä¸ºé˜ˆå€¼ä¾›åç»­æŸ¥æ‰¾ç«¯ç‚¹æ—¶ä½¿ç”¨
float gradientScaled = 0.25*max(abs(gradient1),abs(gradient2));

// çº¹ç´ å°ºå¯¸
float stepLength = isHorizontal ? inverseScreenSize.y : inverseScreenSize.x;

// å¹³å‡äº®åº¦
float lumaLocalAverage = 0.0;

if(is1Steepest){
    // åå‘
    stepLength = - stepLength;
    lumaLocalAverage = 0.5*(luma1 + lumaCenter);
} else {
    lumaLocalAverage = 0.5*(luma2 + lumaCenter);
}

// æ²¿è¾¹ç¼˜æ–¹å‘ç§»åŠ¨åŠä¸ªçº¹ç´ 
vec2 currentUv = In.uv;
if(isHorizontal){
    currentUv.y += stepLength * 0.5;
} else {
    currentUv.x += stepLength * 0.5;
}</code></pre>
</div>

<p>ä¾‹å¦‚å½“å‰ fragment åœ¨çº¢åœˆå¤„ï¼Œç°åœ¨æˆ‘ä»¬æ‰¾åˆ°äº† currentUvï¼ˆç»¿å‰å¤„ï¼‰<br /><img src="/assets/img/webgl/fxaa2.png" alt="image.png" /><br />ä¸‹ä¸€æ­¥éœ€è¦æ‰¾åˆ°è¾¹ç¼˜çš„é¦–å°¾ã€‚</p>

<h2 id="æŸ¥æ‰¾çº¿æ®µç«¯ç‚¹">æŸ¥æ‰¾çº¿æ®µç«¯ç‚¹</h2>
<p>è¿™ä¸€æ­¥ç›¸è¾ƒ MLAA å°±æ›´ç®€å•äº†ï¼Œä¸éœ€è¦è€ƒè™‘ crossing edge çš„å¤šç§å½¢æ€ï¼Œåªéœ€è¦æ²¿è¾¹ç¼˜æ–¹å‘å‘ä¸¤ä¾§æŸ¥æ‰¾ï¼š</p>
<div>
<pre class="line-numbers" data-line=""><code class="language-glsl">// ä¸€ä¸ªçº¹ç´ åç§»é‡
vec2 offset = isHorizontal ? vec2(inverseScreenSize.x,0.0) : vec2(0.0,inverseScreenSize.y);
// å½“å‰è¾¹ç¼˜ç‚¹ä¸¤ä¾§
vec2 uv1 = currentUv - offset;
vec2 uv2 = currentUv + offset;

// ä¸¤ä¾§äº®åº¦ä¸å‡å€¼çš„å·®å€¼
float lumaEnd1 = rgb2luma(texture(screenTexture,uv1).rgb);
float lumaEnd2 = rgb2luma(texture(screenTexture,uv2).rgb);
lumaEnd1 -= lumaLocalAverage;
lumaEnd2 -= lumaLocalAverage;

// å¤§äºè¯¥æ–¹å‘ä¸Šçš„é˜ˆå€¼ï¼Œè®¤ä¸ºåˆ°è¾¾äº†è¾¹ç¼˜çš„ç«¯ç‚¹å¤„
bool reached1 = abs(lumaEnd1) &gt;= gradientScaled;
bool reached2 = abs(lumaEnd2) &gt;= gradientScaled;
bool reachedBoth = reached1 &amp;&amp; reached2;

// æ²¡æœ‰åˆ°è¾¾è¾¹ç¼˜ï¼Œç»§ç»­å‘ä¸¤ä¾§æŸ¥æ‰¾
if(!reached1){
    uv1 -= offset;
}
if(!reached2){
    uv2 += offset;
}</code></pre>
</div>

<p>GLSL ä¸­å¹¶ä¸æ”¯æŒé€’å½’ï¼Œå› æ­¤åªèƒ½é€šè¿‡æœ‰é™æ¬¡çš„å¾ªç¯å®ç°ï¼Œä¸ºäº†æå‡æŸ¥æ‰¾æ•ˆç‡ï¼Œä¼šé€æ¸åŠ å¤§åç§»é‡çš„æ­¥é•¿ QUALITYã€‚å¦å¤–ï¼Œå¦‚æœä¸ä½¿ç”¨ for å¾ªç¯çš„è¯ä¹Ÿå¯ä»¥åµŒå¥—å¤šå±‚ï¼Œfxaa3.glsl ä¸­å°±æ˜¯è¿™ä¹ˆå®ç°çš„ã€‚</p>
<div>
<pre class="line-numbers" data-line=""><code class="language-glsl">if(!reachedBoth){
    for(int i = 2; i &lt; ITERATIONS; i++){
 			  // çœç•¥æ£€æµ‹ä»£ç ï¼ŒåŒä¸Š
        // QUALITY 5æ¬¡ä¹‹åä¼šå¢åŠ ï¼Œä¾‹å¦‚ 1.5, 2.0...
        if(!reached1){
            uv1 -= offset * QUALITY(i);
        }
        if(!reached2){
            uv2 += offset * QUALITY(i);
        }
        // åˆ°è¾¾ç«¯ç‚¹è·³å‡º
        if(reachedBoth){ break; }
    }
}</code></pre>
</div>

<p>ç°åœ¨æˆ‘ä»¬æ‰¾åˆ°äº†çº¿æ®µçš„ç«¯ç‚¹ï¼ˆè“è‰²ï¼‰uv1 uv2ï¼š<br /><img src="/assets/img/webgl/fxaa3.png" alt="image.png" /></p>

<h2 id="æ··åˆ">æ··åˆ</h2>
<p>æ‰¾åˆ°ç«¯ç‚¹åï¼Œéœ€è¦çŸ¥é“Â currentUv ç¦»å“ªä¸ªç«¯ç‚¹æ›´è¿‘ï¼Œä»¥åŠçº¿æ®µæ€»é•¿åº¦ã€‚è¿™æ ·å°±å¯ä»¥è®¡ç®—å‡ºè¦†ç›–ç‡ï¼Œæœ¬è´¨ä¸Šå°±æ˜¯ä¸€ä¸ªçº¿æ€§æ’å€¼æ¸å˜çš„è¿‡ç¨‹ï¼š</p>
<div>
<pre class="line-numbers" data-line=""><code class="language-glsl">// ä¸¤ä¾§çº¿æ®µé•¿åº¦
float distance1 = isHorizontal ? (In.uv.x - uv1.x) : (In.uv.y - uv1.y);
float distance2 = isHorizontal ? (uv2.x - In.uv.x) : (uv2.y - In.uv.y);

// ç¦»å“ªä¸ªç«¯ç‚¹æ›´è¿‘ï¼Ÿ
bool isDirection1 = distance1 &lt; distance2;
float distanceFinal = min(distance1, distance2);

// çº¿æ®µæ€»é•¿åº¦
float edgeThickness = (distance1 + distance2);

// æ‰¾åˆ°
float pixelOffset = - distanceFinal / edgeThickness + 0.5;</code></pre>
</div>

<p>è¿™é‡Œæœ‰ä¸€ç‚¹éœ€è¦æ³¨æ„ï¼Œä¸ºäº†é˜²æ­¢ è¿‘ç«¯ç‚¹äº®åº¦å¤§äºå‡å€¼è€Œä¸­å¿ƒäº®åº¦å°äºå‡å€¼è¿™ç§æƒ…å†µçš„å‡ºç°ï¼Œéœ€è¦ä¿è¯æ•´ä½“äº®åº¦å˜åŒ–æ–¹å‘ä¸€è‡´ã€‚å¦‚æœä¸ä¸€è‡´åˆ™ä¸åº”ç”¨åç§»é‡ï¼š</p>
<div>
<pre class="line-numbers" data-line=""><code class="language-glsl">// ä¸­å¿ƒå’Œå¹³å‡äº®åº¦æ¯”è¾ƒ
bool isLumaCenterSmaller = lumaCenter &lt; lumaLocalAverage;

// è¿‘ç«¯ç‚¹ å’Œ ä¸­å¿ƒåˆ°å¹³å‡äº®åº¦çš„å˜åŒ–ä¸ä¸€è‡´
bool correctVariation = ((isDirection1 ? lumaEnd1 : lumaEnd2) &lt; 0.0) != isLumaCenterSmaller;

// å¦‚æœä¸ä¸€è‡´åˆ™ä¸åº”ç”¨åç§»é‡
float finalOffset = correctVariation ? pixelOffset : 0.0;</code></pre>
</div>

<h3 id="subpixel-antialiasing">Subpixel antialiasing</h3>
<p>å…³äº Sub-Pixel è¿™ç¯‡ã€Œ<strong>Understanding Sub-Pixel (LCD Screen) Anti-Aliased Font Rendering</strong>ã€<a href="http://alienryderflex.com/sub_pixel/">ğŸ”—</a></p>
<blockquote>
  <p>The first circle just turns the whole RGB triplet completely on or completely off.
The second circle varies the strength of each RGB triplet to generate intermediate shades of grey.
But the third circle varies the strength of each display element separately to achieve the best possible rendition of a sharp-edged circle</p>
</blockquote>

<p><br />å¼€å¯åçš„æ•ˆæœå›¾ï¼š<br /><img src="/assets/img/webgl/fxaa4.svg" alt="Antialias-vrs-Cromapixel.svg" /></p>

<p>the amount of sub-pixel aliasing removalï¼Œä¼šå½±å“é”åº¦ï¼š</p>
<div>
<pre class="line-numbers" data-line=""><code class="language-glsl">//   1.00 - upper limit (softer)
//   0.75 - default amount of filtering
//   0.50 - lower limit (sharper, less sub-pixel aliasing removal)
//   0.25 - almost off
//   0.00 - completely off
FxaaFloat fxaaQualitySubpix,</code></pre>
</div>

<p>å– sub-pixel å’Œä¹‹å‰è®¡ç®—å‡ºçš„åç§»é‡çš„è¾ƒå¤§è€…ï¼š</p>
<div>
<pre class="line-numbers" data-line=""><code class="language-glsl">SUBPIXEL_QUALITY = 0.75 // fxaaQualitySubpix

// 3x3 neighborhoodï¼ŒåŠ æƒå¹³å‡ï¼ˆä¸Šä¸‹å·¦å³2ï¼Œå››ä¸ªè§’1ï¼‰
float lumaAverage = (1.0/12.0) * (2.0 * (lumaDownUp + lumaLeftRight) + lumaLeftCorners + lumaRightCorners);
// Ratio of the delta between the global average and the center luma, over the luma range in the 3x3 neighborhood.
float subPixelOffset1 = clamp(abs(lumaAverage - lumaCenter)/lumaRange,0.0,1.0);
float subPixelOffset2 = (-2.0 * subPixelOffset1 + 3.0) * subPixelOffset1 * subPixelOffset1;
// Compute a sub-pixel offset based on this delta.
float subPixelOffsetFinal = subPixelOffset2 * subPixelOffset2 * SUBPIXEL_QUALITY;

// Pick the biggest of the two offsets.
finalOffset = max(finalOffset,subPixelOffsetFinal);</code></pre>
</div>

<h2 id="æœ€ç»ˆæ•ˆæœ">æœ€ç»ˆæ•ˆæœ</h2>
<p>å–åç§»åçš„çº¹ç´ é¢œè‰²ä½œä¸ºæœ€ç»ˆè¾“å‡ºï¼š</p>
<div>
<pre class="line-numbers" data-line=""><code class="language-glsl">// è®¡ç®—åç§»é‡
vec2 finalUv = In.uv;
if(isHorizontal){
    finalUv.y += finalOffset * stepLength;
} else {
    finalUv.x += finalOffset * stepLength;
}

// å–åç§»åçš„çº¹ç´ è¾“å‡º
vec3 finalColor = texture(screenTexture,finalUv).rgb;
fragColor = finalColor;</code></pre>
</div>

<p>ä¼˜ç‚¹å¾ˆæ˜æ˜¾ï¼Œå®ç°ç®€å•å¼€é”€å°ï¼ˆç›¸æ¯” SMAA æ‰€éœ€çš„ä¸‰ä¸ª passï¼ŒFXAA åªéœ€è¦ä¸€ä¸ªï¼‰ï¼Œä½†æ˜¯æ•ˆæœä¸æ˜¯ååˆ†ä¼˜ç§€ã€‚<br /><img src="/assets/img/webgl/fxaa4.png" alt="image.png" /></p>

<p>ä»¥ä¸Šæ˜¯ nvidia åŸä½œè€…æå‡ºçš„ç¬¬ä¸€ç‰ˆ FXAA çš„å®ç°ï¼Œéšåä»–æå‡ºäº†ç›®å‰å¹¿ä¸ºä½¿ç”¨çš„ç¬¬ä¸‰ç‰ˆï¼Œä¹Ÿæ˜¯å¾ˆå¤šå¼•æ“ä¸­é‡‡ç”¨çš„ FXAA 3.xã€‚<br /></p>

<h2 id="fxaa-çš„åç»­æ”¹è¿›">FXAA çš„åç»­æ”¹è¿›</h2>
<p>åœ¨é˜…è¯» clay.gl æºç æ—¶å‘ç°ç›®å‰ä½¿ç”¨çš„ fxaa å®ç°ç›¸å¯¹ç®€å•ï¼Œæ¥è‡ª glsl-fxaa <a href="https://github.com/mattdesl/glsl-fxaa">ğŸ”—</a></p>
<blockquote>
  <p>A WebGL implementation of Fast Approximate Anti-Aliasing (FXAA v2). This is a screen-space technique. The code was originally fromÂ <a href="https://www.geeks3d.com/20110405/fxaa-fast-approximate-anti-aliasing-demo-glsl-opengl-test-radeon-geforce/3/">Geeks3D.com</a>Â and cleaned up byÂ <a href="https://github.com/mitsuhiko/webgl-meincraft">Armin Ronacher</a>Â for WebGL.</p>
</blockquote>

<h3 id="dependent-texture-reads">dependent texture reads</h3>
<p><br /><br />åœ¨è¿™ä¸ªç‰ˆæœ¬çš„å®ç°ä¸­ï¼Œä»‹ç»åˆ°ä½¿ç”¨äº†ä¸€ç§ä¼˜åŒ–æ–¹å¼ï¼š</p>
<blockquote>
  <p>This FXAA shader uses 9 <strong>dependent texture reads</strong>. For various mobile GPUs (particularly iOS), we can optimize the shader by making 5 of the texture2D calls <strong>non-dependent</strong>. To do this, the coordinates have to be computed in the vertex shader and passed along:</p>
</blockquote>

<p>é‚£ä¹ˆå•¥æ˜¯Â **dependent texture reads **å‘¢ï¼Ÿæ¥è‡ª sf çš„ä¸€ä¸ªå›ç­”ï¼š<br /><a href="https://stackoverflow.com/questions/1054096/what-is-a-dependent-texture-read">https://stackoverflow.com/questions/1054096/what-is-a-dependent-texture-read</a></p>
<blockquote>
  <p>An important implication is that the texture coordinates (where you look up from) is not determined until the middle of execution of the shaderâ€¦ thereâ€™s no kind of static analysis you can do on the shader (even knowing the values of all parameters) that will tell you what the <strong>coordinates will be ahead of time</strong></p>
</blockquote>

<p>å› æ­¤ä¸ºäº†åœ¨ç¼–è¯‘æ—¶è€Œéè¿è¡Œæ—¶å°±çŸ¥é“è·å–çº¹ç†åæ ‡ï¼Œåœ¨ vs ä¸­è®¡ç®—å¥½ 4 ä¸ªé‚»å±…åæ ‡å¹¶é€šè¿‡ varying ä¼ é€’ç»™ fsï¼š</p>
<div>
<pre class="line-numbers" data-line=""><code class="language-glsl">// tex.vs

void texcoords(vec2 fragCoord, vec2 resolution,
			out vec2 v_rgbNW, out vec2 v_rgbNE,
			out vec2 v_rgbSW, out vec2 v_rgbSE,
			out vec2 v_rgbM) {
	vec2 inverseVP = 1.0 / resolution.xy;
	v_rgbNW = (fragCoord + vec2(-1.0, -1.0)) * inverseVP;
	v_rgbNE = (fragCoord + vec2(1.0, -1.0)) * inverseVP;
	v_rgbSW = (fragCoord + vec2(-1.0, 1.0)) * inverseVP;
	v_rgbSE = (fragCoord + vec2(1.0, 1.0)) * inverseVP;
	v_rgbM = vec2(fragCoord * inverseVP);
}

#pragma glslify: export(texcoords)</code></pre>
</div>

<p>ä½†æ˜¯ä¸Šé¢é‚£ä¸ªé—®ç­”ä¸­ä¹Ÿæåˆ°äº†ï¼Œè¿™ç§è¿‡äºæ·±å…¥ç¡¬ä»¶ä½“å±‚å®ç°çš„ä¼˜åŒ–åœ¨æ–°æ¬¾ GPU ä¸­å·²ç»æ˜¯ä¸éœ€è¦çš„äº†ã€‚<br />æ¯•ç«Ÿ glsl-fxaa ä¹Ÿæ˜¯å†™äº 4ã€5 å¹´å‰çš„ï¼ŒåŒæ ·çš„è¿˜æœ‰ <a href="https://github.com/mattdesl/three-shader-fxaa">https://github.com/mattdesl/three-shader-fxaa</a>ã€‚<br />ä¸‹é¢æ¥çœ‹çœ‹ FXAA 3.x çš„å®ç°æ–¹å¼ã€‚</p>

<h3 id="3x">3.x</h3>

<p>ç”±äºåŸä½œè€…çš„åšå®¢å·²ç»å¤±æ•ˆäº†ï¼Œç›®å‰åªèƒ½æ‰¾åˆ°è¿™ä¸€ç¯‡å†å²æ–‡æ¡£ï¼š<a href="http://archive.is/Y7Ns">http://archive.is/Y7Ns</a>ï¼Œå…¶ä¸­è¯´åˆ°ä½œè€…å®ç°äº†ç¬¬ä¸€ç‰ˆï¼ˆä¹Ÿå°±æ˜¯ä¸Šé¢çš„åŸºç¡€å®ç°ï¼‰ä¹‹åï¼Œåˆä¼˜åŒ–äº†ç¬¬äºŒã€ä¸‰ç‰ˆï¼Œä½†æ˜¯ç›®å‰æˆ‘åªæ‰¾åˆ°äº† FXAA3ï¼Œä¹Ÿå°±æ˜¯å½“å‰åº”ç”¨å¹¿æ³›çš„å®ç°ã€‚ä¸€å¼€å§‹å…‰çœ‹æ²¡æœ‰æ³¨é‡Šçš„æºç æœ‰äº›éš¾ä»¥ç†è§£ï¼Œç›´è§‚æ„Ÿè§‰å°±æ˜¯ç›¸è¾ƒäºç¬¬ä¸€ç‰ˆè¦ç²¾ç®€ä¸€äº›ã€‚åæ¥æ‰¾åˆ°äº†ä½œè€…åœ¨ SIGGRAPH 2011 ä¸Šçš„ä¸€ä»½ Slide <a href="http://iryoku.com/aacourse/downloads/09-FXAA-3.11-in-15-Slides.pdf">ğŸ”—</a>ï¼Œå…¶ä¸­è¯¦ç»†ä»‹ç»äº†ç®—æ³•çš„æ€è·¯ï¼Œæ‰ç®—çœŸæ­£ç†è§£ã€‚</p>

<p><img src="/assets/img/webgl/fxaa5.png" alt="å±å¹•å¿«ç…§ 2019-02-03 ä¸‹åˆ9.16.00.png" /></p>

<p>é¦–å…ˆæŒ‰ç…§å›¾ä¸­å®šä¹‰çš„ 2 tap filterï¼Œx è½´æ–¹å‘éœ€è¦åå‘ã€‚<br />ç„¶åå– xy äº®åº¦å˜åŒ–å°çš„é‚£ä¸ªæ–¹å‘ï¼Œè¿›è¡Œç¼©æ”¾ã€‚<br />æœ€åé™å®š filter width ä¸º -8 åˆ° 8 ä¹‹é—´ã€‚</p>
<div>
<pre class="line-numbers" data-line=""><code class="language-glsl">mediump vec2 dir;
// x è½´æ–¹å‘éœ€è¦åå‘
dir.x = -((lumaNW + lumaNE) - (lumaSW + lumaSE));
dir.y =  ((lumaNW + lumaSW) - (lumaNE + lumaSE));

float dirReduce = max((lumaNW + lumaNE + lumaSW + lumaSE) *
	(0.25 * FXAA_REDUCE_MUL), FXAA_REDUCE_MIN);

// å–å¾— xy è¾ƒå°çš„å˜åŒ–æ–¹å‘è¿›è¡Œç¼©æ”¾
float rcpDirMin = 1.0 / (min(abs(dir.x), abs(dir.y)) + dirReduce);

// filter width FXAA_SPAN_MAX = 8
dir = min(
	vec2(FXAA_SPAN_MAX, FXAA_SPAN_MAX),
	max(
  	vec2(-FXAA_SPAN_MAX, -FXAA_SPAN_MAX),
		dir * rcpDirMin // ç¼©æ”¾
  )
) * inverseVP;</code></pre>
</div>

<p><img src="/assets/img/webgl/fxaa6.png" alt="å±å¹•å¿«ç…§ 2019-02-03 ä¸‹åˆ9.13.39.png" /></p>
<blockquote>
  <p>If fullâ€width filter width estimation is too large, then there is a chance the filter kernel
will sample from regions off the local edge.
In this case noise will be introduced by the filter kernel.
This step attempts to <strong>remove this noise</strong>.</p>
</blockquote>

<p>é¡ºä¾¿æŠŠ subpixel åèµ°æ ·ä¹Ÿåšäº†ï¼Œå– 0ï¼Œ1/3ï¼Œ2/3 å’Œ 1 å¤„å››ä¸ªçš„çº¹ç´ ï¼š</p>
<div>
<pre class="line-numbers" data-line=""><code class="language-glsl">// 2-tap sub-pixel åèµ°æ · 1/3 å’Œ 2/3
vec3 rgbA = 0.5 * (
  texture2D(tex, fragCoord * inverseVP + dir * (1.0 / 3.0 - 0.5)).xyz +
  texture2D(tex, fragCoord * inverseVP + dir * (2.0 / 3.0 - 0.5)).xyz);
// 4-tap å†åŠ ä¸Š 0 å’Œ 1
vec3 rgbB = rgbA * 0.5 + 0.25 * (
  texture2D(tex, fragCoord * inverseVP + dir * -0.5).xyz +
  texture2D(tex, fragCoord * inverseVP + dir * 0.5).xyz);

float lumaB = dot(rgbB, luma);
// å¦‚æœ 4-tap filter å¼•å…¥çš„å™ªå£°å¯¼è‡´è¶…å‡ºäº†äº®åº¦çš„èŒƒå›´ï¼Œåªè¿”å› 2-tap ç»“æœ
if ((lumaB &lt; lumaMin) || (lumaB &gt; lumaMax))
	color = vec4(rgbA, texColor.a);
else
	color = vec4(rgbB, texColor.a);
return color;</code></pre>
</div>


    </article>
    
    <div class="social-share-wrapper">
        <div class="social-share"></div>
    </div>
    
</div>

<section class="author-detail">
    <section class="post-footer-item author-card">
        <div class="avatar">
            <img src="https://xiaoiver.github.io/assets/img/avatar.jpg" alt="">
        </div>
        <div class="author-name" rel="author">æ½˜å®‡çª</div>
        <div class="bio">
            <p>åˆ†äº«å†™ä»£ç ï¼Œå¬éŸ³ä¹ï¼Œçœ‹ç”µå½±çš„å¿ƒå¾—</p>
        </div>
        
        <ul class="sns-links">
            
            <li>
                <a href="//github.com/xiaoiver" target="_blank">
                    <i class="iconfont icon-github"></i>
                </a>
            </li>
            
            <li>
                <a href="//www.douban.com/people/150275082/" target="_blank">
                    <i class="iconfont icon-douban"></i>
                </a>
            </li>
            
            <li>
                <a href="//www.zhihu.com/people/pan-yu-qi-20/activities" target="_blank">
                    <i class="iconfont icon-zhihu"></i>
                </a>
            </li>
            
        </ul>
        
    </section>
    <section class="post-footer-item read-next">
        
        <div class="read-next-item">
            <a href="/coding/2019/02/02/%E5%8F%8D%E8%B5%B0%E6%A0%B7%E6%8A%80%E6%9C%AF-%E4%B8%89.html" class="read-next-link"></a>
            <section>
                <span>åèµ°æ ·æŠ€æœ¯ï¼ˆä¸‰ï¼‰</span>
                <p>å‰ä¸¤ç¯‡å…³äºå‡ ä½•åèµ°æ · MLAA/SMAA å’Œ FXAA éƒ½æ˜¯åŸºäº post-processing åå¤„ç†å®Œæˆçš„ã€‚åœ¨...</p>
            </section>
            
            <div class="filter"></div>
            <img src="/assets/img/webgl/quaternion.jpg" alt="">
            
        </div>
        
        
        <div class="read-next-item">
            <a href="/coding/2019/01/31/%E5%8F%8D%E8%B5%B0%E6%A0%B7%E6%8A%80%E6%9C%AF-%E4%B8%80.html" class="read-next-link"></a>
            <section>
                <span>åèµ°æ ·æŠ€æœ¯ï¼ˆä¸€ï¼‰</span>
                <p>æœ€è¿‘åœ¨å­¦ä¹ ä¸€äº›é€šç”¨çš„ postprocessing æŠ€æœ¯ï¼Œçœ‹åˆ° Three.js ä¸­çš„ SMAA å®ç°ã€‚ç»“åˆçŸ¥ä¹ä¸Š...</p>
            </section>
            
            <div class="filter"></div>
            <img src="/assets/img/webgl/quaternion.jpg" alt="">
            
        </div>
        
    </section>
    <section class="post-footer-item comment">
        
<hr>
<!-- æ¥å¿…åŠ›Cityç‰ˆå®‰è£…ä»£ç  -->
<div class="container" id="lv-container" data-id="city" data-uid="MTAyMC8zMDQyNy82OTgx">
    <script type="text/javascript">
   (function(d, s) {
       var j, e = d.getElementsByTagName(s)[0];

       if (typeof LivereTower === 'function') { return; }

       j = d.createElement(s);
       j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
       j.async = true;

       e.parentNode.insertBefore(j, e);
   })(document, 'script');
    </script>
<noscript> ä¸ºæ­£å¸¸ä½¿ç”¨æ¥å¿…åŠ›è¯„è®ºåŠŸèƒ½è¯·æ¿€æ´»JavaScript</noscript>
</div>
<!-- Cityç‰ˆå®‰è£…ä»£ç å·²å®Œæˆ -->


    </section>
</section>

<footer class="g-footer">
    <section>xiaOpçš„åšå®¢ Â© 2020</section>
    <section>Powered by <a href="//jekyllrb.com">Jekyll</a> | <a href="https://github.com/kaeyleo/jekyll-theme-H2O">Theme H2O</a></section>
</footer>

<div class="update-toast">
    <span class="update-toast-text">ç«™ç‚¹å‘ç”Ÿæ›´æ–°ï¼Œè¯·æ‰‹åŠ¨åˆ·æ–°</span>
    <span class="update-toast-refresh-btn"></span>
</div>


<script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML' async></script>
<script src="/assets/js/social-share.min.js"></script>
<script>
    socialShare('.social-share', {
        sites: ['wechat','weibo','douban','twitter'],
        wechatQrcodeTitle: "åˆ†äº«åˆ°å¾®ä¿¡æœ‹å‹åœˆ",
        wechatQrcodeHelper: '<p>æ‰«ç åç‚¹å‡»å³ä¸Šè§’</p><p>å°†æœ¬æ–‡åˆ†äº«è‡³æœ‹å‹åœˆ</p>'
    });
</script>
<script src="/assets/js/prism.min.js"></script>
<script src="/assets/js/index.min.js"></script>
<script src="/assets/js/jquery.nav.js"></script>
<script>
    function generateCatalog (selector) {
        // init
        var P = $('.markdown-body'),a,n,t,l,i,c;
        a = P.find('h1,h2,h3,h4,h5,h6');

        // clean
        $(selector).html('')

        // appending
        a.each(function () {
            n = $(this).prop('tagName').toLowerCase();
            i = "#"+$(this).prop('id');
            t = $(this).text();
            c = $('<a href="'+i+'" rel="nofollow">'+t+'</a>');
            l = $('<li class="'+n+'_nav"></li>').append(c);
            $(selector).append(l);
        });
        return true;
    }

    generateCatalog(".catalog-body");

    // toggle side catalog
    $(".catalog-toggle").click((function(e){
        e.preventDefault();
        $('.side-catalog').toggleClass("fold")
    }))

    /*
     * Doc: https://github.com/davist11/jQuery-One-Page-Nav
     * Fork by Hux to support padding
     */
    $('.catalog-body').onePageNav({
        currentClass: "active",
        changeHash: !1,
        easing: "swing",
        filter: "",
        scrollSpeed: 700,
        scrollOffset: 0,
        scrollThreshold: .2,
        begin: null,
        end: null,
        scrollChange: null,
        padding: 80
    });
</script>
</body>
</html>
