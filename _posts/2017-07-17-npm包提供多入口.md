---
layout: post
title:  "npm包提供多入口"
subtitle: "不同模块机制，不同平台环境以及是否需要转译"
header-img: "img/post-bg-js-module.jpg"
date:   2017-07-17 19:21:32
category: coding
tags: javascript nodejs babel webpack
---

## 问题背景

之前给[webpack-cdn-plugin](https://github.com/van-nguyen/webpack-cdn-plugin)提PR时，遇到这样一个问题，入口文件使用了部分 ES6 特性，而作者不想直接提供转译版本，这就导致在低版本 Node.js 环境无法直接运行。

`package.json`中的`main`只能支持单文件，无法提供多入口供使用者根据自身环境选择。

当时的做法是在入口文件中判断当前运行环境，选择使用转译或非转译版本。

前段时间刚好看到[这一系列文章](http://2ality.com/2017/04/setting-up-multi-platform-packages.html)，算是给出了较为全面的解决方案。

## 多种模块机制版本

模块格式包括：
* AMD 浏览器端异步模块机制
* CJS Node.js同步模块机制，浏览器端想使用必须先使用类似 webpack 之类的工具编译成异步的
* ESM ES6提出内置机制支持同步和异步，部分浏览器已支持，Node.js端2018年？

UMD支持[在 Node.js 中写类似 AMD 的代码](https://github.com/umdjs/umd/blob/master/templates/nodeAdapter.js)

在`package.json`中暴露多种模块格式的入口，通过`main`，`module`和`browser`字段。

angular提出`es2015`，直接使用ES6非转译版本。

在 webpack 中，可以通过`resolve.mainFields`指定模块查找优先级。例如`target: 'web'`默认的优先级为：`["browser", "module", "main"]`。

## 转译和非转译版本

参考 babel-preset-env 的做法根据运行环境决定是否需要使用 transpiled 版本代码

### babel-preset-env

首先看看`babel-preset-env`是如何使用的。针对浏览器环境：
{% highlight json %}
"babel": {
    "presets": [
        [
            "env",
            {
                "targets": {
                    "browsers": ["last 2 versions", "ie >= 7"]
                }
            }
        ]
    ]
}
{% endhighlight %}

针对 Node.js 环境：
{% highlight json %}
"babel": {
    "presets": [
        [
            "env",
            {
                "targets": {
                    "node": "current"
                }
            }
        ]
    ]
}
{% endhighlight %}

其他参数包括：
* modules 默认CJS，不转译`false`
* useBuiltIns 使用polyfill，注入类似`import "core-js/modules/es7.string.pad-start";`的代码

### esnext

增加一个新的入口`esnext`。直接提供支持 stage4 以上特性的代码，不使用转译，使用ESM：
{% highlight json %}
{
    ···
    "main": "main.js",
    "esnext": {
        "main": "main-esnext.js",
        "browser": "browser-specific-main-esnext.js"
    },
    ···
}
{% endhighlight %}

[具体做法](http://2ality.com/2017/06/pkg-esnext.html)是：
* 对于模块开发者，提供非转译版本的`esnext`
* 对于使用者，通过`resolve.mainFields`将`esnext`加入，赋予最高优先级，同时告知 babel-loader 转译提供`esnext`的代码。剩下的就交给[babel-preset-env](http://2ality.com/2017/02/babel-preset-env.html)根据提供的配置环境自动引入需要的插件。

### 其他做法

1. 全部转译，耗时但是配置简单
2. [配置 babel-loader，只转译提供了 module 字段的依赖](https://gist.github.com/developit/081148d83348ebe9a1bc1ba0707e1bb8)
3. 根据后缀，js不转译，esm转译

## 总结

作为模块提供者，我会采用`esnext`的方式，提供非转译版本。然后让使用者根据运行环境选择使用。
